<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PERP INSIGHTS — Crypto Perp Dashboard</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;600&family=Orbitron:wght@600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0a0e17;
      --neon:#00ff9d;
      --purple:#6366f1;
    }
    html,body{ height:100%; }
    body{
      background:
        radial-gradient(1200px 600px at 10% 10%, rgba(99,102,241,0.18), transparent 55%),
        radial-gradient(1000px 500px at 90% 15%, rgba(0,255,157,0.12), transparent 55%),
        radial-gradient(900px 500px at 35% 95%, rgba(99,102,241,0.12), transparent 60%),
        var(--bg);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color: #e5e7eb;
    }
    .font-orbitron{ font-family: Orbitron, system-ui, sans-serif; }
    .font-monoNums{ font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }

    /* Glassmorphism card */
    .glass{
      background: rgba(17, 24, 39, 0.45);
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow:
        0 16px 50px rgba(0,0,0,0.45),
        inset 0 1px 0 rgba(255,255,255,0.05);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
    }

    /* Neon ring / glow */
    .neon-ring{
      box-shadow: 0 0 0 1px rgba(0,255,157,0.22), 0 0 18px rgba(0,255,157,0.12);
    }
    .purple-ring{
      box-shadow: 0 0 0 1px rgba(99,102,241,0.22), 0 0 18px rgba(99,102,241,0.12);
    }

    /* Tab pills */
    .tab-pill{
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(11, 18, 32, 0.45);
      transition: transform .15s ease, box-shadow .15s ease, border-color .15s ease;
    }
    .tab-pill:hover{
      transform: translateY(-1px);
      box-shadow: 0 12px 30px rgba(0,0,0,0.35);
      border-color: rgba(0,255,157,0.22);
    }
    .tab-pill.active{
      border-color: rgba(0,255,157,0.35);
      box-shadow:
        0 0 0 1px rgba(0,255,157,0.25),
        0 0 22px rgba(0,255,157,0.14);
    }

    /* Table zebra + hover */
    .zebra tbody tr:nth-child(odd){ background: rgba(255,255,255,0.02); }
    .zebra tbody tr:hover{ background: rgba(255,255,255,0.05); transform: translateZ(0); }

    /* Highlight row >= 5bp with glow */
    .hot-row{
      box-shadow: 0 0 0 1px rgba(0,255,157,0.22), 0 0 22px rgba(0,255,157,0.12);
      background: rgba(0,255,157,0.06) !important;
    }

    /* Live status pulse */
    .pulse-dot{
      width: 10px; height: 10px; border-radius: 9999px;
      background: var(--neon);
      box-shadow: 0 0 0 0 rgba(0,255,157,0.55);
      animation: pulse 1.6s infinite;
    }
    @keyframes pulse{
      0% { box-shadow: 0 0 0 0 rgba(0,255,157,0.45); }
      70%{ box-shadow: 0 0 0 10px rgba(0,255,157,0.00); }
      100%{ box-shadow: 0 0 0 0 rgba(0,255,157,0.00); }
    }

    /* Gradient button */
    .btn-grad{
      background: linear-gradient(135deg, rgba(0,255,157,0.22), rgba(99,102,241,0.22));
      border: 1px solid rgba(255,255,255,0.10);
      transition: transform .15s ease, box-shadow .15s ease;
    }
    .btn-grad:hover{ transform: translateY(-1px); box-shadow: 0 18px 40px rgba(0,0,0,0.4); }
    .btn-ghost{
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(11, 18, 32, 0.35);
      transition: transform .15s ease, border-color .15s ease;
    }
    .btn-ghost:hover{ transform: translateY(-1px); border-color: rgba(99,102,241,0.28); }

    /* Header */
    .header-glass{
      background: rgba(10, 14, 23, 0.55);
      border-bottom: 1px solid rgba(255,255,255,0.07);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
    }
    .content-pad{ padding-top: 112px; } /* slightly bigger because more tabs */

    /* Inputs */
    .input-glass{
      background: rgba(11, 18, 32, 0.45);
      border: 1px solid rgba(255,255,255,0.10);
    }
    .input-glass:focus{
      outline: none;
      border-color: rgba(0,255,157,0.35);
      box-shadow: 0 0 0 1px rgba(0,255,157,0.22), 0 0 16px rgba(0,255,157,0.10);
    }
  </style>
</head>

<body>
  <!-- Fixed Header -->
  <header class="header-glass fixed top-0 left-0 right-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-2xl glass neon-ring flex items-center justify-center">
          <div class="w-4 h-4 rounded-md" style="background: linear-gradient(135deg, var(--neon), var(--purple));"></div>
        </div>
        <div>
          <div class="font-orbitron text-lg sm:text-xl tracking-[0.22em] text-white">
            PERP INSIGHTS
          </div>
          <div class="text-xs text-gray-400">
            Cyber-finance dashboard · Live perp pricing + funding
          </div>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <div class="flex items-center gap-2 glass px-3 py-2 rounded-2xl">
          <div class="pulse-dot"></div>
          <div class="text-xs text-gray-200">
            <span class="text-gray-400">Status:</span>
            <span id="liveStatusText" class="font-monoNums">Connecting…</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-4">
      <div class="flex gap-2 overflow-x-auto pb-1">
        <button class="tab-pill active px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap" data-tab="prices">Prices</button>
        <button class="tab-pill px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap" data-tab="funding">Funding</button>
        <button class="tab-pill px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap" data-tab="leaderboard">Leaderboard</button>
        <button class="tab-pill px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap" data-tab="spreadcalc">Spread convergence calculator</button>
        <button class="tab-pill px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap" data-tab="fundarb">Funding arb calculator</button>
        <button class="tab-pill px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap" data-tab="daily">Daily insights</button>
      </div>
    </div>
  </header>

  <main class="content-pad">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 space-y-6">

      <!-- Filters -->
      <section class="glass rounded-3xl p-5 sm:p-6">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div>
            <div class="font-orbitron text-sm tracking-[0.18em] text-gray-100">FILTERS</div>
            <div class="text-xs text-gray-400 mt-1" id="filterStatus">Choose exchanges + coins, then “Apply filters”.</div>
          </div>
          <div class="flex gap-2">
            <button class="btn-ghost px-4 py-2 rounded-xl text-sm" id="resetFilters">Reset defaults</button>
            <button class="btn-grad px-4 py-2 rounded-xl text-sm" id="applyFilters">Apply filters</button>
          </div>
        </div>

        <div class="mt-5 grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="glass rounded-2xl p-4 purple-ring">
            <div class="text-xs text-gray-300 font-semibold mb-3">Exchanges</div>
            <div class="grid grid-cols-2 gap-2" id="exchChecks"></div>
            <div class="mt-3 flex gap-2">
              <button class="btn-ghost px-3 py-2 rounded-xl text-xs" id="exAll">Select all</button>
              <button class="btn-ghost px-3 py-2 rounded-xl text-xs" id="exNone">Clear</button>
            </div>
          </div>

          <div class="glass rounded-2xl p-4 neon-ring">
            <div class="text-xs text-gray-300 font-semibold mb-3">Coins</div>
            <div class="max-h-56 overflow-auto pr-2 grid grid-cols-3 gap-2" id="coinChecks"></div>
            <div class="mt-3 flex gap-2">
              <button class="btn-ghost px-3 py-2 rounded-xl text-xs" id="cAll">Select all</button>
              <button class="btn-ghost px-3 py-2 rounded-xl text-xs" id="cNone">Clear</button>
            </div>
          </div>
        </div>

        <div class="mt-4 text-xs text-gray-400">
          <span class="text-gray-300 font-semibold">Row glow:</span>
          rows highlight when spread across selected exchanges ≥ <span class="font-monoNums" style="color:var(--neon)">5 bps</span>.
        </div>
      </section>

      <!-- PRICES TAB -->
      <section id="tab-prices" class="tab-panel space-y-4">
        <div class="glass rounded-3xl p-5 sm:p-6">
          <div class="flex flex-wrap items-center justify-between gap-3">
            <div>
              <div class="font-orbitron text-sm tracking-[0.18em] text-gray-100">PRICES</div>
              <div class="text-xs text-gray-400 mt-1">
                Spread bps = 10,000 × (max − min) / min · “24h High” stored in your browser
              </div>
            </div>
            <div class="text-xs text-gray-200 glass rounded-2xl px-3 py-2">
              <span class="text-gray-400">Updated:</span>
              <span id="priceStatus" class="font-monoNums">Loading…</span>
            </div>
          </div>

          <div class="mt-4 overflow-x-auto rounded-2xl">
            <table class="w-full zebra">
              <thead id="pricesHead" class="text-xs uppercase tracking-wider text-gray-300"></thead>
              <tbody id="priceRows" class="text-sm"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- FUNDING TAB -->
      <section id="tab-funding" class="tab-panel hidden space-y-4">
        <div class="glass rounded-3xl p-5 sm:p-6">
          <div class="flex flex-wrap items-center justify-between gap-3">
            <div>
              <div class="font-orbitron text-sm tracking-[0.18em] text-gray-100">FUNDING</div>
              <div class="text-xs text-gray-400 mt-1">
                365-day = rate_per_window × (365×24 / interval_hours)
              </div>
            </div>
            <div class="text-xs text-gray-200 glass rounded-2xl px-3 py-2">
              <span class="text-gray-400">Updated:</span>
              <span id="fundingStatus" class="font-monoNums">Loading…</span>
            </div>
          </div>

          <div class="mt-4 overflow-x-auto rounded-2xl">
            <table class="w-full zebra">
              <thead id="fundingHead" class="text-xs uppercase tracking-wider text-gray-300"></thead>
              <tbody id="fundingRows" class="text-sm"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- LEADERBOARD TAB -->
      <section id="tab-leaderboard" class="tab-panel hidden space-y-4">
        <div class="glass rounded-3xl p-5 sm:p-6">
          <div class="flex flex-wrap items-center justify-between gap-3">
            <div>
              <div class="font-orbitron text-sm tracking-[0.18em] text-gray-100">LEADERBOARD</div>
              <div class="text-xs text-gray-400 mt-1">
                Ranked by highest spread (bps) across your selected exchanges
              </div>
            </div>
            <div class="text-xs text-gray-200 glass rounded-2xl px-3 py-2">
              <span class="text-gray-400">Snapshot:</span>
              <span id="leaderStatus" class="font-monoNums">Waiting…</span>
            </div>
          </div>

          <div class="mt-4 overflow-x-auto rounded-2xl">
            <table class="w-full zebra">
              <thead class="text-xs uppercase tracking-wider text-gray-300">
                <tr>
                  <th class="py-3 px-3 text-left">Coin</th>
                  <th class="py-3 px-3 text-left">Buy @</th>
                  <th class="py-3 px-3 text-left">Sell @</th>
                  <th class="py-3 px-3 text-right">Spread (bps)</th>
                  <th class="py-3 px-3 text-right">24h High (bps)</th>
                </tr>
              </thead>
              <tbody id="leaderRows" class="text-sm">
                <tr><td colspan="5" class="py-4 px-3 text-xs text-gray-400">Waiting for first price refresh…</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- SPREAD CONVERGENCE CALCULATOR TAB -->
      <section id="tab-spreadcalc" class="tab-panel hidden space-y-4">
        <div class="glass rounded-3xl p-5 sm:p-6">
          <div class="flex flex-wrap items-center justify-between gap-3">
            <div>
              <div class="font-orbitron text-sm tracking-[0.18em] text-gray-100">SPREAD CONVERGENCE CALCULATOR</div>
              <div class="text-xs text-gray-400 mt-1">
                Uses live prices · Gross ≈ Notional × (Convergence bps / 10,000)
              </div>
            </div>
          </div>

          <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="glass rounded-2xl p-4 purple-ring">
              <div class="text-xs text-gray-300 font-semibold mb-3">Inputs</div>

              <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div>
                  <label class="text-xs text-gray-400">Asset</label>
                  <select id="arbAsset" class="mt-1 w-full rounded-xl px-3 py-2 input-glass text-sm"></select>
                </div>
                <div>
                  <label class="text-xs text-gray-400">Notional (USD)</label>
                  <input id="arbNotional" type="number" value="100000" min="0" step="1000"
                         class="mt-1 w-full rounded-xl px-3 py-2 input-glass text-sm font-monoNums">
                </div>

                <div>
                  <label class="text-xs text-gray-400">Buy exchange</label>
                  <select id="arbBuyEx" class="mt-1 w-full rounded-xl px-3 py-2 input-glass text-sm"></select>
                </div>
                <div>
                  <label class="text-xs text-gray-400">Sell exchange</label>
                  <select id="arbSellEx" class="mt-1 w-full rounded-xl px-3 py-2 input-glass text-sm"></select>
                </div>

                <div>
                  <label class="text-xs text-gray-400">Target convergence (bps)</label>
                  <input id="arbConvBps" type="number" value="5" step="0.1"
                         class="mt-1 w-full rounded-xl px-3 py-2 input-glass text-sm font-monoNums">
                </div>
                <div>
                  <label class="text-xs text-gray-400">Total costs (bps)</label>
                  <input id="arbCostsBps" type="number" value="3" step="0.1"
                         class="mt-1 w-full rounded-xl px-3 py-2 input-glass text-sm font-monoNums">
                </div>
              </div>

              <div class="mt-4 flex gap-2">
                <button class="btn-grad px-4 py-2 rounded-xl text-sm" id="arbRecalc">Recalculate</button>
              </div>
            </div>

            <div class="glass rounded-2xl p-4 neon-ring">
              <div class="text-xs text-gray-300 font-semibold mb-3">Output</div>

              <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div class="glass rounded-2xl p-3">
                  <div class="text-xs text-gray-400">Current buy/sell spread</div>
                  <div id="arbCurBps" class="mt-1 font-monoNums text-lg">—</div>
                </div>
                <div class="glass rounded-2xl p-3">
                  <div class="text-xs text-gray-400">Gross PnL (USD)</div>
                  <div id="arbGross" class="mt-1 font-monoNums text-lg">—</div>
                </div>
                <div class="glass rounded-2xl p-3">
                  <div class="text-xs text-gray-400">Costs (USD)</div>
                  <div id="arbCosts" class="mt-1 font-monoNums text-lg">—</div>
                </div>
                <div class="glass rounded-2xl p-3">
                  <div class="text-xs text-gray-400">Net PnL (USD)</div>
                  <div id="arbNet" class="mt-1 font-monoNums text-lg">—</div>
                </div>
              </div>

              <div class="mt-4 text-xs text-gray-400">
                Tip: pick the cheapest exchange as Buy and most expensive as Sell for a pure spread convergence arb.
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- FUNDING ARB CALCULATOR TAB -->
      <section id="tab-fundarb" class="tab-panel hidden space-y-4">
        <div class="glass rounded-3xl p-5 sm:p-6">
          <div class="flex flex-wrap items-center justify-between gap-3">
            <div>
              <div class="font-orbitron text-sm tracking-[0.18em] text-gray-100">FUNDING ARB CALCULATOR</div>
              <div class="text-xs text-gray-400 mt-1">
                Long one venue, short the other · Uses live funding + each venue interval
              </div>
            </div>
          </div>

          <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="glass rounded-2xl p-4 purple-ring">
              <div class="text-xs text-gray-300 font-semibold mb-3">Inputs</div>

              <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div>
                  <label class="text-xs text-gray-400">Asset</label>
                  <select id="faAsset" class="mt-1 w-full rounded-xl px-3 py-2 input-glass text-sm"></select>
                </div>
                <div>
                  <label class="text-xs text-gray-400">Notional (USD) per leg</label>
                  <input id="faNotional" type="number" value="100000" min="0" step="1000"
                         class="mt-1 w-full rounded-xl px-3 py-2 input-glass text-sm font-monoNums">
                </div>

                <div>
                  <label class="text-xs text-gray-400">Long venue</label>
                  <select id="faLongEx" class="mt-1 w-full rounded-xl px-3 py-2 input-glass text-sm"></select>
                </div>
                <div>
                  <label class="text-xs text-gray-400">Short venue</label>
                  <select id="faShortEx" class="mt-1 w-full rounded-xl px-3 py-2 input-glass text-sm"></select>
                </div>

                <div>
                  <label class="text-xs text-gray-400">Holding period (hours)</label>
                  <input id="faHoldHours" type="number" value="24" min="0" step="1"
                         class="mt-1 w-full rounded-xl px-3 py-2 input-glass text-sm font-monoNums">
                </div>
                <div>
                  <label class="text-xs text-gray-400">Total costs (bps)</label>
                  <input id="faCostsBps" type="number" value="3" step="0.1"
                         class="mt-1 w-full rounded-xl px-3 py-2 input-glass text-sm font-monoNums">
                </div>
              </div>

              <div class="mt-4 flex gap-2">
                <button class="btn-grad px-4 py-2 rounded-xl text-sm" id="faRecalc">Recalculate</button>
              </div>

              <div class="mt-3 text-xs text-gray-400">
                Assumes “positive funding = longs pay shorts”. If an exchange reports the opposite sign, tell me and I’ll flip it.
              </div>
            </div>

            <div class="glass rounded-2xl p-4 neon-ring">
              <div class="text-xs text-gray-300 font-semibold mb-3">Output</div>

              <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div class="glass rounded-2xl p-3">
                  <div class="text-xs text-gray-400">Long funding / interval</div>
                  <div id="faLongFund" class="mt-1 font-monoNums text-lg">—</div>
                </div>
                <div class="glass rounded-2xl p-3">
                  <div class="text-xs text-gray-400">Long interval / windows</div>
                  <div class="mt-1 font-monoNums text-lg"><span id="faLongInt">—</span> · <span id="faLongWin">—</span></div>
                </div>

                <div class="glass rounded-2xl p-3">
                  <div class="text-xs text-gray-400">Short funding / interval</div>
                  <div id="faShortFund" class="mt-1 font-monoNums text-lg">—</div>
                </div>
                <div class="glass rounded-2xl p-3">
                  <div class="text-xs text-gray-400">Short interval / windows</div>
                  <div class="mt-1 font-monoNums text-lg"><span id="faShortInt">—</span> · <span id="faShortWin">—</span></div>
                </div>

                <div class="glass rounded-2xl p-3">
                  <div class="text-xs text-gray-400">Funding PnL (USD)</div>
                  <div id="faFundingPnl" class="mt-1 font-monoNums text-lg">—</div>
                </div>
                <div class="glass rounded-2xl p-3">
                  <div class="text-xs text-gray-400">Net (after costs)</div>
                  <div id="faNet" class="mt-1 font-monoNums text-lg">—</div>
                </div>
              </div>

              <div class="mt-3 text-xs text-gray-400">
                Funding PnL model uses each venue’s funding interval and your chosen holding hours.
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- DAILY INSIGHTS TAB -->
      <section id="tab-daily" class="tab-panel hidden space-y-4">
        <div class="glass rounded-3xl p-5 sm:p-6">
          <div class="flex flex-wrap items-center justify-between gap-3">
            <div>
              <div class="font-orbitron text-sm tracking-[0.18em] text-gray-100">DAILY INSIGHTS (LAST 24H)</div>
              <div class="text-xs text-gray-400 mt-1">
                Best observed opportunities in the last 24 hours (based on what your browser has observed)
              </div>
            </div>
            <div class="text-xs text-gray-200 glass rounded-2xl px-3 py-2">
              <span class="text-gray-400">Updated:</span>
              <span id="dailyStatus" class="font-monoNums">Collecting…</span>
            </div>
          </div>

          <div class="mt-4 overflow-x-auto rounded-2xl">
            <table class="w-full zebra">
              <thead class="text-xs uppercase tracking-wider text-gray-300">
                <tr>
                  <th class="py-3 px-3 text-left">Insight</th>
                  <th class="py-3 px-3 text-left">Coin</th>
                  <th class="py-3 px-3 text-left">Action</th>
                  <th class="py-3 px-3 text-right">Metric</th>
                  <th class="py-3 px-3 text-right">Observed</th>
                </tr>
              </thead>
              <tbody id="dailyRows" class="text-sm">
                <tr><td colspan="5" class="py-4 px-3 text-xs text-gray-400">Waiting for data…</td></tr>
              </tbody>
            </table>
          </div>

          <div class="mt-3 text-xs text-gray-500">
            Note: GitHub Pages is static — “last 24h” uses browser localStorage and only includes data observed while the site is running.
          </div>
        </div>
      </section>

      <footer class="pb-10 text-xs text-gray-500">
        <div class="text-center">
          Built with vanilla JS · Tailwind · Glassmorphism · Neon accents
        </div>
      </footer>

    </div>
  </main>

<script>
  // ======================================================================
  // IMPORTANT: DATA LOGIC UNCHANGED (same fetch + calculations as before).
  // Only structure/styling has been upgraded + missing tabs restored.
  // ======================================================================

  // === your worker ===
  const PROXY_BASE = "https://purple-sky-264e.jasper-cooney.workers.dev/?url=";

  const BPS_HIGHLIGHT = 5;
  const PRICES_REFRESH_MS = 3000;
  const FUNDING_REFRESH_MS = 60000;

  // 24h high spread across SELECTED exchanges (minute buckets)
  const HIGH_WINDOW_MINUTES = 24 * 60;
  const HIGH_STORE_KEY = "perpinsights_24h_high_spread_bps_v2";

  // Daily Insights store (24h)
  const DAILY_STORE_KEY = "perpinsights_daily_insights_v1";
  const DAILY_WINDOW_MINUTES = 24 * 60;

  // Same coins you currently had
  const COINS = ["BTC","ETH","SOL","XRP","ZEC","DOGE","ADA","LINK","AVAX","LTC","BCH","DOT"];

  // Exchange list
  const EXCHANGES = [
    { key:"hyper",  name:"Hyperliquid" },
    { key:"aster",  name:"Aster" },
    { key:"kraken", name:"Kraken" },
    { key:"okx",    name:"OKX" },
  ];

  // Symbol mappings per exchange
  const MAP = {
    hyper:  { BTC:"BTC", ETH:"ETH", SOL:"SOL", XRP:"XRP", ZEC:"ZEC", DOGE:"DOGE", ADA:"ADA", LINK:"LINK", AVAX:"AVAX", LTC:"LTC", BCH:"BCH", DOT:"DOT" },
    aster:  { BTC:"BTCUSDT", ETH:"ETHUSDT", SOL:"SOLUSDT", XRP:"XRPUSDT", ZEC:"ZECUSDT", DOGE:"DOGEUSDT", ADA:"ADAUSDT", LINK:"LINKUSDT", AVAX:"AVAXUSDT", LTC:"LTCUSDT", BCH:"BCHUSDT", DOT:"DOTUSDT" },
    okx:    { BTC:"BTC-USDT-SWAP", ETH:"ETH-USDT-SWAP", SOL:"SOL-USDT-SWAP", XRP:"XRP-USDT-SWAP", ZEC:"ZEC-USDT-SWAP", DOGE:"DOGE-USDT-SWAP", ADA:"ADA-USDT-SWAP", LINK:"LINK-USDT-SWAP", AVAX:"AVAX-USDT-SWAP", LTC:"LTC-USDT-SWAP", BCH:"BCH-USDT-SWAP", DOT:"DOT-USDT-SWAP" },
    // Kraken Futures perpetuals commonly use XBT not BTC
    kraken: { BTC:"PF_XBTUSD", ETH:"PF_ETHUSD", SOL:"PF_SOLUSD", XRP:"PF_XRPUSD", ZEC:"PF_ZECUSD", DOGE:"PF_DOGEUSD", ADA:"PF_ADAUSD", LINK:"PF_LINKUSD", AVAX:"PF_AVAXUSD", LTC:"PF_LTCUSD", BCH:"PF_BCHUSD", DOT:"PF_DOTUSD" },
  };

  // ===== DOM =====
  const liveStatusText = document.getElementById("liveStatusText");

  const exchChecks = document.getElementById("exchChecks");
  const coinChecks = document.getElementById("coinChecks");
  const filterStatus = document.getElementById("filterStatus");

  const pricesHead = document.getElementById("pricesHead");
  const priceRows = document.getElementById("priceRows");
  const priceStatus = document.getElementById("priceStatus");

  const fundingHead = document.getElementById("fundingHead");
  const fundingRows = document.getElementById("fundingRows");
  const fundingStatus = document.getElementById("fundingStatus");

  const leaderStatus = document.getElementById("leaderStatus");
  const leaderRows = document.getElementById("leaderRows");

  // Spread convergence calculator (same ids as earlier arb calc)
  const arbAsset = document.getElementById("arbAsset");
  const arbBuyEx = document.getElementById("arbBuyEx");
  const arbSellEx = document.getElementById("arbSellEx");
  const arbNotional = document.getElementById("arbNotional");
  const arbConvBps = document.getElementById("arbConvBps");
  const arbCostsBps = document.getElementById("arbCostsBps");
  const arbRecalc = document.getElementById("arbRecalc");
  const arbCurBps = document.getElementById("arbCurBps");
  const arbGross = document.getElementById("arbGross");
  const arbCosts = document.getElementById("arbCosts");
  const arbNet = document.getElementById("arbNet");

  // Funding arb calculator (restored)
  const faAsset = document.getElementById("faAsset");
  const faLongEx = document.getElementById("faLongEx");
  const faShortEx = document.getElementById("faShortEx");
  const faNotional = document.getElementById("faNotional");
  const faHoldHours = document.getElementById("faHoldHours");
  const faCostsBps = document.getElementById("faCostsBps");
  const faRecalc = document.getElementById("faRecalc");
  const faLongFund = document.getElementById("faLongFund");
  const faLongInt = document.getElementById("faLongInt");
  const faLongWin = document.getElementById("faLongWin");
  const faShortFund = document.getElementById("faShortFund");
  const faShortInt = document.getElementById("faShortInt");
  const faShortWin = document.getElementById("faShortWin");
  const faFundingPnl = document.getElementById("faFundingPnl");
  const faNet = document.getElementById("faNet");

  // Daily insights (restored)
  const dailyStatus = document.getElementById("dailyStatus");
  const dailyRows = document.getElementById("dailyRows");

  // ===== Tabs =====
  function initTabs() {
    const btns = document.querySelectorAll(".tab-pill");
    const panels = {
      prices: document.getElementById("tab-prices"),
      funding: document.getElementById("tab-funding"),
      leaderboard: document.getElementById("tab-leaderboard"),
      spreadcalc: document.getElementById("tab-spreadcalc"),
      fundarb: document.getElementById("tab-fundarb"),
      daily: document.getElementById("tab-daily"),
    };

    btns.forEach(b => {
      b.addEventListener("click", () => {
        btns.forEach(x => x.classList.remove("active"));
        b.classList.add("active");

        for (const p of Object.values(panels)) p.classList.add("hidden");
        panels[b.dataset.tab].classList.remove("hidden");

        if (b.dataset.tab === "spreadcalc") renderArb();
        if (b.dataset.tab === "fundarb") renderFundingArb();
        if (b.dataset.tab === "leaderboard") renderLeaderboard();
        if (b.dataset.tab === "daily") renderDailyInsights();
      });
    });
  }

  // ===== Filters state =====
  const FILTER_KEY = "perpinsights_filters_v1";
  let selectedEx = new Set(EXCHANGES.map(x => x.key));
  let selectedCoins = new Set(COINS);

  function saveFilters() {
    try {
      localStorage.setItem(FILTER_KEY, JSON.stringify({
        ex: [...selectedEx],
        coins: [...selectedCoins],
      }));
    } catch {}
  }
  function loadFilters() {
    try {
      const raw = localStorage.getItem(FILTER_KEY);
      if (!raw) return;
      const j = JSON.parse(raw);
      if (Array.isArray(j.ex)) selectedEx = new Set(j.ex);
      if (Array.isArray(j.coins)) selectedCoins = new Set(j.coins);
    } catch {}
  }

  function renderFilterUI() {
    exchChecks.innerHTML = EXCHANGES.map(e => `
      <label class="flex items-center gap-2 text-sm text-gray-200">
        <input type="checkbox" class="accent-[var(--neon)]" data-ex="${e.key}" ${selectedEx.has(e.key) ? "checked" : ""}/>
        <span>${e.name}</span>
      </label>
    `).join("");

    coinChecks.innerHTML = COINS.map(c => `
      <label class="flex items-center gap-2 text-sm text-gray-200">
        <input type="checkbox" class="accent-[var(--purple)]" data-coin="${c}" ${selectedCoins.has(c) ? "checked" : ""}/>
        <span class="font-monoNums">${c}</span>
      </label>
    `).join("");

    exchChecks.querySelectorAll("input[type=checkbox]").forEach(cb => {
      cb.addEventListener("change", () => {
        const k = cb.dataset.ex;
        cb.checked ? selectedEx.add(k) : selectedEx.delete(k);
      });
    });

    coinChecks.querySelectorAll("input[type=checkbox]").forEach(cb => {
      cb.addEventListener("change", () => {
        const k = cb.dataset.coin;
        cb.checked ? selectedCoins.add(k) : selectedCoins.delete(k);
      });
    });
  }

  function setAllEx(on) {
    selectedEx = new Set(on ? EXCHANGES.map(x=>x.key) : []);
    renderFilterUI();
  }
  function setAllCoins(on) {
    selectedCoins = new Set(on ? COINS : []);
    renderFilterUI();
  }

  document.getElementById("exAll").onclick = () => setAllEx(true);
  document.getElementById("exNone").onclick = () => setAllEx(false);
  document.getElementById("cAll").onclick = () => setAllCoins(true);
  document.getElementById("cNone").onclick = () => setAllCoins(false);

  document.getElementById("applyFilters").onclick = () => {
    if (selectedEx.size < 1) { alert("Select at least 1 exchange"); return; }
    if (selectedCoins.size < 1) { alert("Select at least 1 coin"); return; }

    saveFilters();
    filterStatus.textContent = `Applied: ${selectedEx.size} exchanges, ${selectedCoins.size} coins.`;
    buildTables();
    refreshAllDropdowns();
    refreshPrices();
    refreshFunding();
  };

  document.getElementById("resetFilters").onclick = () => {
    selectedEx = new Set(EXCHANGES.map(x=>x.key));
    selectedCoins = new Set(COINS);
    saveFilters();
    renderFilterUI();
    document.getElementById("applyFilters").click();
  };

  // ===== Helpers =====
  function nowMinuteEpoch() { return Math.floor(Date.now() / 60000); }

  function exName(exKey) {
    return (EXCHANGES.find(e => e.key === exKey)?.name) || exKey;
  }

  function fmtUsd(x) {
    if (x === undefined || x === null || x === "" || Number.isNaN(Number(x))) return "—";
    const n = Number(x);
    return n >= 1
      ? "$" + n.toLocaleString(undefined, { maximumFractionDigits: 2 })
      : "$" + n.toLocaleString(undefined, { maximumFractionDigits: 6 });
  }
  function fmtBpsAbs(x) {
    if (!Number.isFinite(x)) return "—";
    const abs = Math.abs(x);
    return abs.toFixed(abs < 10 ? 2 : 1) + " bps";
  }
  function fmtBpsSigned(x) {
    if (!Number.isFinite(x)) return { text:"—", cls:"" };
    const abs = Math.abs(x);
    return { text: (x>=0?"+":"−") + abs.toFixed(abs < 10 ? 2 : 1) + " bps", cls: x>0?"text-emerald-300":(x<0?"text-rose-300":"") };
  }
  function fmtFunding(rate) {
    if (!Number.isFinite(rate)) return "—";
    const p = rate * 100;
    return (p>=0?"":"−") + Math.abs(p).toFixed(Math.abs(p) < 0.01 ? 4 : 3) + "%";
  }
  function fmtIntervalH(h) {
    if (!Number.isFinite(h) || h<=0) return "—";
    return h.toFixed(h < 10 ? 2 : 1) + "h";
  }
  function aprFromRate(ratePerWindow, intervalH) {
    if (!Number.isFinite(ratePerWindow) || !Number.isFinite(intervalH) || intervalH<=0) return "—";
    const windowsPerYear = (365*24)/intervalH;
    const apr = ratePerWindow * windowsPerYear * 100;
    return (apr>=0?"":"−") + Math.abs(apr).toFixed(Math.abs(apr) < 1 ? 3 : 2) + "%";
  }
  function money(x) {
    if (!Number.isFinite(x)) return "—";
    return (x>=0?"":"−") + "$" + Math.abs(x).toLocaleString(undefined, { maximumFractionDigits: 2 });
  }

  async function fetchJson(url, options) {
    const r = await fetch(PROXY_BASE + encodeURIComponent(url), { cache:"no-store", ...(options||{}) });
    if (!r.ok) throw new Error(String(r.status));
    return r.json();
  }

  // ===== Local storage: 24h High spread =====
  let highStore = {}; // { [coin]: [{m, s}] }

  function loadHighStore() {
    try { highStore = JSON.parse(localStorage.getItem(HIGH_STORE_KEY) || "{}"); } catch { highStore = {}; }
  }
  function saveHighStore() {
    try { localStorage.setItem(HIGH_STORE_KEY, JSON.stringify(highStore)); } catch {}
  }
  function pruneHighStore() {
    const cutoff = nowMinuteEpoch() - HIGH_WINDOW_MINUTES;
    for (const c of Object.keys(highStore)) {
      const arr = Array.isArray(highStore[c]) ? highStore[c] : [];
      highStore[c] = arr.filter(x => x && Number.isFinite(x.m) && x.m >= cutoff && Number.isFinite(x.s));
      if (highStore[c].length === 0) delete highStore[c];
    }
  }
  function updateHigh(coin, spreadAbsBps) {
    if (!Number.isFinite(spreadAbsBps)) return;
    const m = nowMinuteEpoch();
    if (!Array.isArray(highStore[coin])) highStore[coin] = [];
    const arr = highStore[coin];
    const last = arr.length ? arr[arr.length - 1] : null;
    if (last && last.m === m) {
      if (spreadAbsBps > last.s) last.s = spreadAbsBps;
    } else {
      arr.push({ m, s: spreadAbsBps });
    }
    const cutoff = m - HIGH_WINDOW_MINUTES;
    while (arr.length && arr[0].m < cutoff) arr.shift();
  }
  function get24hHigh(coin) {
    const arr = highStore[coin];
    if (!Array.isArray(arr) || !arr.length) return null;
    let best = arr[0];
    for (const x of arr) if (x && Number.isFinite(x.s) && x.s > best.s) best = x;
    return best;
  }

  // ===== Daily Insights store =====
  // Tracks best observed spread arb + best observed funding arb over last 24h (browser-observed).
  let dailyStore = { spread: {}, funding: {} };

  function loadDailyStore() {
    try {
      dailyStore = JSON.parse(localStorage.getItem(DAILY_STORE_KEY) || '{"spread":{},"funding":{}}');
      if (!dailyStore.spread) dailyStore.spread = {};
      if (!dailyStore.funding) dailyStore.funding = {};
    } catch {
      dailyStore = { spread: {}, funding: {} };
    }
  }
  function saveDailyStore() {
    try { localStorage.setItem(DAILY_STORE_KEY, JSON.stringify(dailyStore)); } catch {}
  }
  function pruneDailyStore() {
    const cutoff = nowMinuteEpoch() - DAILY_WINDOW_MINUTES;

    for (const coin of Object.keys(dailyStore.spread || {})) {
      const arr = Array.isArray(dailyStore.spread[coin]) ? dailyStore.spread[coin] : [];
      dailyStore.spread[coin] = arr.filter(x => x && Number.isFinite(x.m) && x.m >= cutoff && Number.isFinite(x.bps));
      if (!dailyStore.spread[coin].length) delete dailyStore.spread[coin];
    }

    for (const coin of Object.keys(dailyStore.funding || {})) {
      const arr = Array.isArray(dailyStore.funding[coin]) ? dailyStore.funding[coin] : [];
      dailyStore.funding[coin] = arr.filter(x => x && Number.isFinite(x.m) && x.m >= cutoff && Number.isFinite(x.apr));
      if (!dailyStore.funding[coin].length) delete dailyStore.funding[coin];
    }
  }

  function updateDailySpread(coin, spreadBpsAbs, buyEx, sellEx) {
    if (!Number.isFinite(spreadBpsAbs)) return;
    const m = nowMinuteEpoch();
    if (!Array.isArray(dailyStore.spread[coin])) dailyStore.spread[coin] = [];
    const arr = dailyStore.spread[coin];
    const last = arr.length ? arr[arr.length - 1] : null;

    if (last && last.m === m) {
      if (spreadBpsAbs > last.bps) {
        last.bps = spreadBpsAbs;
        last.buyEx = buyEx;
        last.sellEx = sellEx;
      }
    } else {
      arr.push({ m, bps: spreadBpsAbs, buyEx, sellEx });
    }

    const cutoff = m - DAILY_WINDOW_MINUTES;
    while (arr.length && arr[0].m < cutoff) arr.shift();
  }

  function updateDailyFunding(coin, netAprPct, longEx, shortEx) {
    if (!Number.isFinite(netAprPct)) return;
    const m = nowMinuteEpoch();
    if (!Array.isArray(dailyStore.funding[coin])) dailyStore.funding[coin] = [];
    const arr = dailyStore.funding[coin];
    const last = arr.length ? arr[arr.length - 1] : null;

    if (last && last.m === m) {
      if (netAprPct > last.apr) {
        last.apr = netAprPct;
        last.longEx = longEx;
        last.shortEx = shortEx;
      }
    } else {
      arr.push({ m, apr: netAprPct, longEx, shortEx });
    }

    const cutoff = m - DAILY_WINDOW_MINUTES;
    while (arr.length && arr[0].m < cutoff) arr.shift();
  }

  function bestSpread24h() {
    pruneDailyStore();
    let best = null;
    for (const [coin, arr] of Object.entries(dailyStore.spread || {})) {
      for (const x of (arr || [])) {
        if (!x || !Number.isFinite(x.bps)) continue;
        if (!best || x.bps > best.bps) best = { coin, ...x };
      }
    }
    return best;
  }

  function bestFunding24h() {
    pruneDailyStore();
    let best = null;
    for (const [coin, arr] of Object.entries(dailyStore.funding || {})) {
      for (const x of (arr || [])) {
        if (!x || !Number.isFinite(x.apr)) continue;
        if (!best || x.apr > best.apr) best = { coin, ...x };
      }
    }
    return best;
  }

  function renderDailyInsights() {
    if (!dailyRows || !dailyStatus) return;

    const s = bestSpread24h();
    const f = bestFunding24h();

    const rows = [];

    if (s) {
      rows.push(`
        <tr class="${(s.bps >= BPS_HIGHLIGHT) ? "hot-row" : ""}">
          <td class="py-3 px-3 font-semibold">Spread convergence</td>
          <td class="py-3 px-3 font-monoNums">${s.coin}</td>
          <td class="py-3 px-3">Buy <span class="text-emerald-200 font-semibold">${exName(s.buyEx)}</span> / Sell <span class="text-purple-200 font-semibold">${exName(s.sellEx)}</span></td>
          <td class="py-3 px-3 text-right font-monoNums">${fmtBpsAbs(s.bps)}</td>
          <td class="py-3 px-3 text-right font-monoNums">${new Date(s.m*60000).toLocaleString()}</td>
        </tr>
      `);
    } else {
      rows.push(`
        <tr>
          <td class="py-3 px-3 font-semibold">Spread convergence</td>
          <td class="py-3 px-3">—</td>
          <td class="py-3 px-3 text-gray-400 text-xs">Waiting for price history…</td>
          <td class="py-3 px-3 text-right">—</td>
          <td class="py-3 px-3 text-right">—</td>
        </tr>
      `);
    }

    if (f) {
      rows.push(`
        <tr>
          <td class="py-3 px-3 font-semibold">Funding rate arb</td>
          <td class="py-3 px-3 font-monoNums">${f.coin}</td>
          <td class="py-3 px-3">Long <span class="text-emerald-200 font-semibold">${exName(f.longEx)}</span> / Short <span class="text-purple-200 font-semibold">${exName(f.shortEx)}</span></td>
          <td class="py-3 px-3 text-right font-monoNums">${f.apr.toFixed(Math.abs(f.apr) < 1 ? 3 : 2)}%</td>
          <td class="py-3 px-3 text-right font-monoNums">${new Date(f.m*60000).toLocaleString()}</td>
        </tr>
      `);
    } else {
      rows.push(`
        <tr>
          <td class="py-3 px-3 font-semibold">Funding rate arb</td>
          <td class="py-3 px-3">—</td>
          <td class="py-3 px-3 text-gray-400 text-xs">Waiting for funding history…</td>
          <td class="py-3 px-3 text-right">—</td>
          <td class="py-3 px-3 text-right">—</td>
        </tr>
      `);
    }

    dailyRows.innerHTML = rows.join("");
    dailyStatus.textContent = `${new Date().toLocaleTimeString()} · last 24h`;
  }

  // ===== Data caches =====
  const prices = {};   // prices[exchange][coin] = number
  const funding = {};  // funding[exchange][coin] = { rate, intervalH }

  // ===== Leaderboard cache =====
  let lastSpreadSnapshot = []; // [{coin, spreadBps, buyEx, sellEx}]

  // ===== Fetchers (same as before) =====
  async function loadHyperliquid() {
    const j = await fetchJson("https://api.hyperliquid.xyz/info", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ type:"metaAndAssetCtxs" })
    });
    const meta = j[0], ctxs = j[1];
    const map = new Map();
    meta.universe.forEach((u,i) => map.set(u.name, ctxs[i] || {}));

    for (const coin of COINS) {
      const sym = MAP.hyper[coin];
      if (!sym) continue;
      const c = map.get(sym);
      const px = Number(c?.markPx);
      const fr = Number(c?.funding);
      if (!prices.hyper) prices.hyper = {};
      if (!funding.hyper) funding.hyper = {};
      if (Number.isFinite(px)) prices.hyper[coin] = px;
      if (Number.isFinite(fr)) funding.hyper[coin] = { rate: fr, intervalH: 1 }; // hourly
    }
  }

  async function loadAster() {
    const [p, prem] = await Promise.all([
      fetchJson("https://fapi.asterdex.com/fapi/v1/ticker/price"),
      fetchJson("https://fapi.asterdex.com/fapi/v1/premiumIndex")
    ]);

    const pMap = new Map();
    if (Array.isArray(p)) for (const x of p) pMap.set(x.symbol, x.price);

    const fMap = new Map();
    if (Array.isArray(prem)) for (const x of prem) fMap.set(x.symbol, x);

    for (const coin of COINS) {
      const sym = MAP.aster[coin];
      if (!sym) continue;

      const px = Number(pMap.get(sym));
      if (!prices.aster) prices.aster = {};
      if (Number.isFinite(px)) prices.aster[coin] = px;

      const obj = fMap.get(sym);
      const r = Number(obj?.lastFundingRate ?? obj?.fundingRate ?? obj?.funding);
      let intervalH = null;
      const last = Number(obj?.lastFundingTime);
      const next = Number(obj?.nextFundingTime);
      if (Number.isFinite(last) && Number.isFinite(next) && next > last) intervalH = (next-last)/3600000;
      if (!Number.isFinite(intervalH) || intervalH<=0) intervalH = 8;

      if (!funding.aster) funding.aster = {};
      if (Number.isFinite(r)) funding.aster[coin] = { rate: r, intervalH };
    }
  }

  async function loadOKX() {
    const tickTasks = [];
    const fundTasks = [];

    for (const coin of COINS) {
      const instId = MAP.okx[coin];
      if (!instId) continue;

      tickTasks.push((async () => {
        const j = await fetchJson(`https://www.okx.com/api/v5/market/ticker?instId=${encodeURIComponent(instId)}`);
        const d = j?.data?.[0];
        const px = Number(d?.last ?? d?.markPx ?? d?.idxPx);
        if (!prices.okx) prices.okx = {};
        if (Number.isFinite(px)) prices.okx[coin] = px;
      })());

      fundTasks.push((async () => {
        const j = await fetchJson(`https://www.okx.com/api/v5/public/funding-rate?instId=${encodeURIComponent(instId)}`);
        const d = j?.data?.[0];
        const r = Number(d?.fundingRate);
        const ft = Number(d?.fundingTime);
        const nft = Number(d?.nextFundingTime);
        let intervalH = null;
        if (Number.isFinite(ft) && Number.isFinite(nft) && nft > ft) intervalH = (nft-ft)/3600000;
        if (!Number.isFinite(intervalH) || intervalH<=0) intervalH = 8;
        if (!funding.okx) funding.okx = {};
        if (Number.isFinite(r)) funding.okx[coin] = { rate: r, intervalH };
      })());
    }

    await Promise.allSettled([...tickTasks, ...fundTasks]);
  }

  async function loadKrakenFutures() {
    const j = await fetchJson("https://futures.kraken.com/derivatives/api/v3/tickers");
    const arr = j?.tickers || j?.result || j;
    const tMap = new Map();
    if (Array.isArray(arr)) {
      for (const t of arr) {
        const sym = t?.symbol || t?.instrument || t?.product_id;
        if (sym) tMap.set(sym, t);
      }
    }

    if (!prices.kraken) prices.kraken = {};
    if (!funding.kraken) funding.kraken = {};

    for (const coin of COINS) {
      const sym = MAP.kraken[coin];
      const t = tMap.get(sym);
      if (!t) continue;

      const px = Number(t?.markPrice ?? t?.mark_price ?? t?.last ?? t?.lastPrice ?? t?.last_price);
      if (Number.isFinite(px)) prices.kraken[coin] = px;

      const fr = Number(t?.fundingRate ?? t?.funding_rate ?? t?.funding_rate_prediction ?? t?.fundingRatePrediction);
      if (Number.isFinite(fr)) funding.kraken[coin] = { rate: fr, intervalH: 1 };
    }
  }

  // ===== Build table headers =====
  function buildTables() {
    const exList = EXCHANGES.filter(e => selectedEx.has(e.key));

    pricesHead.innerHTML = `
      <tr>
        <th class="py-3 px-3 text-left">Asset</th>
        ${exList.map(e => `<th class="py-3 px-3 text-right">${e.name}</th>`).join("")}
        <th class="py-3 px-3 text-right">Spread (bps)</th>
        <th class="py-3 px-3 text-right">24h High (bps)</th>
      </tr>
    `;

    fundingHead.innerHTML = `
      <tr>
        <th class="py-3 px-3 text-left">Asset</th>
        ${exList.map(e => `
          <th class="py-3 px-3 text-right">${e.name} Funding</th>
          <th class="py-3 px-3 text-right">${e.name} Interval</th>
          <th class="py-3 px-3 text-right">${e.name} 365-day</th>
        `).join("")}
      </tr>
    `;
  }

  // ===== Render Prices =====
  function renderPrices() {
    pruneHighStore();
    pruneDailyStore();

    const exList = EXCHANGES.filter(e => selectedEx.has(e.key));
    const coinsList = COINS.filter(c => selectedCoins.has(c));
    const spreadSnap = [];

    priceRows.innerHTML = coinsList.map(coin => {
      const pxs = []; // [{ex, p}]
      const cells = exList.map(e => {
        const p = prices?.[e.key]?.[coin];
        if (Number.isFinite(p)) pxs.push({ ex: e.key, p });
        return `<td class="py-3 px-3 text-right font-monoNums">${fmtUsd(p)}</td>`;
      }).join("");

      let spreadBps = null;
      let buyEx = null;
      let sellEx = null;

      if (pxs.length >= 2) {
        pxs.sort((a,b) => a.p - b.p);
        const min = pxs[0];
        const max = pxs[pxs.length - 1];
        if (min.p > 0) {
          spreadBps = 10000 * (max.p - min.p) / min.p;
          buyEx = min.ex;
          sellEx = max.ex;
        }
      }

      if (Number.isFinite(spreadBps)) {
        updateHigh(coin, spreadBps);
        updateDailySpread(coin, spreadBps, buyEx, sellEx);
        spreadSnap.push({ coin, spreadBps, buyEx, sellEx });
      }

      const hi = get24hHigh(coin);
      const hot = Number.isFinite(spreadBps) && spreadBps >= BPS_HIGHLIGHT;
      const spreadTxt = Number.isFinite(spreadBps) ? fmtBpsAbs(spreadBps) : "—";
      const highTxt = hi ? fmtBpsAbs(hi.s) : "—";
      const title = hi ? `title="Observed at: ${new Date(hi.m*60000).toLocaleString()}"` : "";

      return `
        <tr class="${hot ? "hot-row" : ""}">
          <td class="py-3 px-3 font-monoNums">${coin}</td>
          ${cells}
          <td class="py-3 px-3 text-right font-monoNums">${spreadTxt}</td>
          <td class="py-3 px-3 text-right font-monoNums" ${title}>${highTxt}</td>
        </tr>
      `;
    }).join("");

    saveHighStore();
    saveDailyStore();

    lastSpreadSnapshot = spreadSnap
      .slice()
      .sort((a,b) => (b.spreadBps ?? -Infinity) - (a.spreadBps ?? -Infinity));

    renderLeaderboard();
    renderDailyInsights();
  }

  // ===== Render Funding =====
  function renderFunding() {
    const exList = EXCHANGES.filter(e => selectedEx.has(e.key));
    const coinsList = COINS.filter(c => selectedCoins.has(c));

    fundingRows.innerHTML = coinsList.map(coin => {
      const cells = exList.map(e => {
        const rec = funding?.[e.key]?.[coin];
        const r = Number(rec?.rate);
        const ih = Number(rec?.intervalH);
        return `
          <td class="py-3 px-3 text-right font-monoNums">${fmtFunding(r)}</td>
          <td class="py-3 px-3 text-right font-monoNums">${fmtIntervalH(ih)}</td>
          <td class="py-3 px-3 text-right font-monoNums">${aprFromRate(r, ih)}</td>
        `;
      }).join("");

      return `<tr><td class="py-3 px-3 font-monoNums">${coin}</td>${cells}</tr>`;
    }).join("");
  }

  // ===== Leaderboard =====
  function renderLeaderboard() {
    const now = new Date().toLocaleTimeString();
    leaderStatus.textContent = lastSpreadSnapshot.length ? now : "Waiting…";

    if (!lastSpreadSnapshot.length) {
      leaderRows.innerHTML = `<tr><td colspan="5" class="py-4 px-3 text-xs text-gray-400">Waiting for first price refresh…</td></tr>`;
      return;
    }

    const top = lastSpreadSnapshot.slice(0, 20);
    leaderRows.innerHTML = top.map(row => {
      const hi = get24hHigh(row.coin);
      const hot = Number.isFinite(row.spreadBps) && row.spreadBps >= BPS_HIGHLIGHT;
      return `
        <tr class="${hot ? "hot-row" : ""}">
          <td class="py-3 px-3 font-monoNums">${row.coin}</td>
          <td class="py-3 px-3">${row.buyEx ? `<span class="text-emerald-200 font-semibold">${exName(row.buyEx)}</span>` : "—"}</td>
          <td class="py-3 px-3">${row.sellEx ? `<span class="text-purple-200 font-semibold">${exName(row.sellEx)}</span>` : "—"}</td>
          <td class="py-3 px-3 text-right font-monoNums">${Number.isFinite(row.spreadBps) ? fmtBpsAbs(row.spreadBps) : "—"}</td>
          <td class="py-3 px-3 text-right font-monoNums">${hi ? fmtBpsAbs(hi.s) : "—"}</td>
        </tr>
      `;
    }).join("");
  }

  // ===== Dropdowns =====
  function refreshAllDropdowns() {
    const coinsList = COINS.filter(c => selectedCoins.has(c));
    const exList = EXCHANGES.filter(e => selectedEx.has(e.key));

    // Spread convergence calc
    arbAsset.innerHTML = coinsList.map(c => `<option value="${c}">${c}</option>`).join("");
    arbBuyEx.innerHTML = exList.map(e => `<option value="${e.key}">${e.name}</option>`).join("");
    arbSellEx.innerHTML = exList.map(e => `<option value="${e.key}">${e.name}</option>`).join("");

    // Funding arb calc
    faAsset.innerHTML = coinsList.map(c => `<option value="${c}">${c}</option>`).join("");
    faLongEx.innerHTML = exList.map(e => `<option value="${e.key}">${e.name}</option>`).join("");
    faShortEx.innerHTML = exList.map(e => `<option value="${e.key}">${e.name}</option>`).join("");

    if (coinsList.length) {
      if (!coinsList.includes(arbAsset.value)) arbAsset.value = coinsList[0];
      if (!coinsList.includes(faAsset.value)) faAsset.value = coinsList[0];
    }
    if (exList.length >= 2) {
      arbBuyEx.value = exList[0].key;
      arbSellEx.value = exList[1].key;
      faLongEx.value = exList[0].key;
      faShortEx.value = exList[1].key;
    }
  }

  // ===== Spread convergence calculator (same logic as earlier arb) =====
  function renderArb() {
    const coin = arbAsset.value;
    const buy = arbBuyEx.value;
    const sell = arbSellEx.value;

    const buyPx = Number(prices?.[buy]?.[coin]);
    const sellPx = Number(prices?.[sell]?.[coin]);

    let curBps = null;
    if (Number.isFinite(buyPx) && Number.isFinite(sellPx) && buyPx > 0) {
      curBps = 10000 * (sellPx - buyPx) / buyPx;
    }
    const bpsCell = Number.isFinite(curBps) ? fmtBpsSigned(curBps) : { text: "—", cls: "" };
    arbCurBps.textContent = bpsCell.text;
    arbCurBps.className = "mt-1 font-monoNums text-lg " + (bpsCell.cls || "");

    const notional = Number(arbNotional.value || 0);
    const conv = Number(arbConvBps.value || 0);
    const costsBps = Number(arbCostsBps.value || 0);

    const gross = notional * (conv / 10000);
    const costs = notional * (costsBps / 10000);
    const net = gross - costs;

    arbGross.textContent = money(gross);
    arbCosts.textContent = money(costs);
    arbNet.textContent = money(net);
    arbNet.className = "mt-1 font-monoNums text-lg " + (net >= 0 ? "text-emerald-300" : "text-rose-300");
  }

  // ===== Funding arb calculator (restored, same logic as earlier version) =====
  function renderFundingArb() {
    const coin = faAsset.value;
    const longEx = faLongEx.value;
    const shortEx = faShortEx.value;

    const longRec = funding?.[longEx]?.[coin];
    const shortRec = funding?.[shortEx]?.[coin];

    const longRate = Number(longRec?.rate);
    const shortRate = Number(shortRec?.rate);
    const longInt = Number(longRec?.intervalH);
    const shortInt = Number(shortRec?.intervalH);

    const holdH = Math.max(0, Number(faHoldHours.value || 0));
    const notional = Number(faNotional.value || 0);
    const costsBps = Number(faCostsBps.value || 0);

    const longWin = (Number.isFinite(longInt) && longInt > 0) ? (holdH / longInt) : null;
    const shortWin = (Number.isFinite(shortInt) && shortInt > 0) ? (holdH / shortInt) : null;

    faLongFund.textContent = fmtFunding(longRate);
    faLongInt.textContent = fmtIntervalH(longInt);
    faLongWin.textContent = (longWin === null) ? "—" : longWin.toFixed(2);

    faShortFund.textContent = fmtFunding(shortRate);
    faShortInt.textContent = fmtIntervalH(shortInt);
    faShortWin.textContent = (shortWin === null) ? "—" : shortWin.toFixed(2);

    if (longEx === shortEx) {
      faFundingPnl.textContent = "Choose different venues";
      faNet.textContent = "—";
      faNet.className = "mt-1 font-monoNums text-lg";
      return;
    }

    if (!Number.isFinite(longRate) || !Number.isFinite(shortRate) || !Number.isFinite(longWin) || !Number.isFinite(shortWin)) {
      faFundingPnl.textContent = "Waiting for funding…";
      faNet.textContent = "—";
      faNet.className = "mt-1 font-monoNums text-lg";
      return;
    }

    // Convention: positive funding = longs pay shorts
    const pnlLong = notional * (-longRate) * longWin;
    const pnlShort = notional * (+shortRate) * shortWin;
    const fundingPnl = pnlLong + pnlShort;

    const costs = notional * (costsBps / 10000);
    const net = fundingPnl - costs;

    faFundingPnl.textContent = money(fundingPnl);
    faNet.textContent = money(net);
    faNet.className = "mt-1 font-monoNums text-lg " + (net >= 0 ? "text-emerald-300" : "text-rose-300");
  }

  // ===== Update Daily funding best pair from current snapshot =====
  function updateDailyFundingFromCurrent() {
    const exList = EXCHANGES.filter(e => selectedEx.has(e.key));
    const coinsList = COINS.filter(c => selectedCoins.has(c));

    for (const coin of coinsList) {
      const perHour = []; // {ex, rph}
      for (const e of exList) {
        const rec = funding?.[e.key]?.[coin];
        const r = Number(rec?.rate);
        const ih = Number(rec?.intervalH);
        if (!Number.isFinite(r) || !Number.isFinite(ih) || ih <= 0) continue;
        perHour.push({ ex: e.key, rph: r / ih });
      }
      if (perHour.length < 2) continue;

      // Best carry: long the most negative rph, short the most positive rph
      perHour.sort((a,b) => a.rph - b.rph);
      const bestLong = perHour[0];
      const bestShort = perHour[perHour.length - 1];

      const netPerHour = (-bestLong.rph) + (bestShort.rph);
      const netAprPct = netPerHour * 24 * 365 * 100;

      if (Number.isFinite(netAprPct) && netAprPct > 0) {
        updateDailyFunding(coin, netAprPct, bestLong.ex, bestShort.ex);
      }
    }
    pruneDailyStore();
    saveDailyStore();
    renderDailyInsights();
  }

  // ===== Refresh loops =====
  async function refreshPrices() {
    const start = Date.now();
    priceStatus.textContent = "Updating…";

    for (const ex of Object.keys(prices)) prices[ex] = {};

    const tasks = [];
    if (selectedEx.has("hyper")) tasks.push(loadHyperliquid());
    if (selectedEx.has("aster")) tasks.push(loadAster());
    if (selectedEx.has("okx")) tasks.push(loadOKX());
    if (selectedEx.has("kraken")) tasks.push(loadKrakenFutures());

    const results = await Promise.allSettled(tasks);
    const ok = results.some(r => r.status === "fulfilled");

    renderPrices();
    renderArb();

    const ms = Date.now() - start;
    priceStatus.textContent = `${new Date().toLocaleTimeString()} · ${ms}ms`;

    liveStatusText.textContent = ok ? "LIVE" : "DEGRADED";
    liveStatusText.style.color = ok ? "var(--neon)" : "#fca5a5";
  }

  async function refreshFunding() {
    const start = Date.now();
    fundingStatus.textContent = "Updating…";

    for (const ex of Object.keys(funding)) funding[ex] = {};

    const tasks = [];
    if (selectedEx.has("hyper")) tasks.push(loadHyperliquid());
    if (selectedEx.has("aster")) tasks.push(loadAster());
    if (selectedEx.has("okx")) tasks.push(loadOKX());
    if (selectedEx.has("kraken")) tasks.push(loadKrakenFutures());

    const results = await Promise.allSettled(tasks);
    const ok = results.some(r => r.status === "fulfilled");

    renderFunding();
    renderFundingArb();
    updateDailyFundingFromCurrent();

    const ms = Date.now() - start;
    fundingStatus.textContent = `${new Date().toLocaleTimeString()} · ${ms}ms`;

    liveStatusText.textContent = ok ? "LIVE" : "DEGRADED";
    liveStatusText.style.color = ok ? "var(--neon)" : "#fca5a5";
  }

  // ===== Init =====
  function init() {
    initTabs();

    loadFilters();
    loadHighStore();
    loadDailyStore();
    pruneHighStore();
    pruneDailyStore();
    saveHighStore();
    saveDailyStore();

    renderFilterUI();
    buildTables();
    refreshAllDropdowns();

    // events
    arbRecalc.onclick = renderArb;
    faRecalc.onclick = renderFundingArb;

    ["change","input"].forEach(ev => {
      arbAsset.addEventListener(ev, renderArb);
      arbBuyEx.addEventListener(ev, renderArb);
      arbSellEx.addEventListener(ev, renderArb);
      arbNotional.addEventListener(ev, renderArb);
      arbConvBps.addEventListener(ev, renderArb);
      arbCostsBps.addEventListener(ev, renderArb);

      faAsset.addEventListener(ev, renderFundingArb);
      faLongEx.addEventListener(ev, renderFundingArb);
      faShortEx.addEventListener(ev, renderFundingArb);
      faNotional.addEventListener(ev, renderFundingArb);
      faHoldHours.addEventListener(ev, renderFundingArb);
      faCostsBps.addEventListener(ev, renderFundingArb);
    });

    // first fetch
    refreshPrices();
    refreshFunding();
    renderLeaderboard();
    renderDailyInsights();

    setInterval(refreshPrices, PRICES_REFRESH_MS);
    setInterval(refreshFunding, FUNDING_REFRESH_MS);

    liveStatusText.textContent = "LIVE";
    liveStatusText.style.color = "var(--neon)";
  }

  init();
</script>
</body>
</html>
