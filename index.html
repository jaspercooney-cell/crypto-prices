<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PERP INSIGHTS — Crypto Perp Dashboard</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;600&family=Orbitron:wght@600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0a0e17;
      --neon:#00ff9d;
      --purple:#6366f1;
    }

    html,body{ height:100%; }
    body{
      background:
        radial-gradient(1200px 600px at 10% 10%, rgba(99,102,241,0.18), transparent 55%),
        radial-gradient(1000px 500px at 90% 15%, rgba(0,255,157,0.12), transparent 55%),
        radial-gradient(900px 500px at 35% 95%, rgba(99,102,241,0.12), transparent 60%),
        var(--bg);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color: #e5e7eb;
    }

    .font-orbitron{ font-family: Orbitron, system-ui, sans-serif; }
    .font-monoNums{ font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }

    /* Glassmorphism card */
    .glass{
      background: rgba(17, 24, 39, 0.45);
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow:
        0 16px 50px rgba(0,0,0,0.45),
        inset 0 1px 0 rgba(255,255,255,0.05);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
    }

    /* Neon ring / glow */
    .neon-ring{
      box-shadow: 0 0 0 1px rgba(0,255,157,0.22), 0 0 18px rgba(0,255,157,0.12);
    }
    .purple-ring{
      box-shadow: 0 0 0 1px rgba(99,102,241,0.22), 0 0 18px rgba(99,102,241,0.12);
    }

    /* Tab pills */
    .tab-pill{
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(11, 18, 32, 0.45);
      transition: transform .15s ease, box-shadow .15s ease, border-color .15s ease;
    }
    .tab-pill:hover{
      transform: translateY(-1px);
      box-shadow: 0 12px 30px rgba(0,0,0,0.35);
      border-color: rgba(0,255,157,0.22);
    }
    .tab-pill.active{
      border-color: rgba(0,255,157,0.35);
      box-shadow:
        0 0 0 1px rgba(0,255,157,0.25),
        0 0 22px rgba(0,255,157,0.14);
    }

    /* Table zebra + hover */
    .zebra tbody tr:nth-child(odd){ background: rgba(255,255,255,0.02); }
    .zebra tbody tr:hover{
      background: rgba(255,255,255,0.05);
      transform: translateZ(0);
    }

    /* Highlight row >= 5bp with glow */
    .hot-row{
      box-shadow: 0 0 0 1px rgba(0,255,157,0.22), 0 0 22px rgba(0,255,157,0.12);
      background: rgba(0,255,157,0.06) !important;
    }

    /* Live status pulse */
    .pulse-dot{
      width: 10px; height: 10px; border-radius: 9999px;
      background: var(--neon);
      box-shadow: 0 0 0 0 rgba(0,255,157,0.55);
      animation: pulse 1.6s infinite;
    }
    @keyframes pulse{
      0% { box-shadow: 0 0 0 0 rgba(0,255,157,0.45); }
      70%{ box-shadow: 0 0 0 10px rgba(0,255,157,0.00); }
      100%{ box-shadow: 0 0 0 0 rgba(0,255,157,0.00); }
    }

    /* Gradient button */
    .btn-grad{
      background: linear-gradient(135deg, rgba(0,255,157,0.22), rgba(99,102,241,0.22));
      border: 1px solid rgba(255,255,255,0.10);
      transition: transform .15s ease, box-shadow .15s ease;
    }
    .btn-grad:hover{
      transform: translateY(-1px);
      box-shadow: 0 18px 40px rgba(0,0,0,0.4);
    }
    .btn-ghost{
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(11, 18, 32, 0.35);
      transition: transform .15s ease, border-color .15s ease;
    }
    .btn-ghost:hover{
      transform: translateY(-1px);
      border-color: rgba(99,102,241,0.28);
    }

    /* Make header glass */
    .header-glass{
      background: rgba(10, 14, 23, 0.55);
      border-bottom: 1px solid rgba(255,255,255,0.07);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
    }

    /* Ensure content clears fixed header */
    .content-pad{
      padding-top: 92px;
    }

    /* Inputs */
    .input-glass{
      background: rgba(11, 18, 32, 0.45);
      border: 1px solid rgba(255,255,255,0.10);
    }
    .input-glass:focus{
      outline: none;
      border-color: rgba(0,255,157,0.35);
      box-shadow: 0 0 0 1px rgba(0,255,157,0.22), 0 0 16px rgba(0,255,157,0.10);
    }
  </style>
</head>

<body>
  <!-- Fixed Header -->
  <header class="header-glass fixed top-0 left-0 right-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-2xl glass neon-ring flex items-center justify-center">
          <div class="w-4 h-4 rounded-md" style="background: linear-gradient(135deg, var(--neon), var(--purple));"></div>
        </div>
        <div>
          <div class="font-orbitron text-lg sm:text-xl tracking-[0.22em] text-white">
            PERP INSIGHTS
          </div>
          <div class="text-xs text-gray-400">
            Cyber-finance dashboard · Live perp pricing + funding
          </div>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <div class="flex items-center gap-2 glass px-3 py-2 rounded-2xl">
          <div class="pulse-dot"></div>
          <div class="text-xs text-gray-200">
            <span class="text-gray-400">Status:</span>
            <span id="liveStatusText" class="font-monoNums">Connecting…</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-4">
      <div class="flex gap-2 overflow-x-auto pb-1">
        <button class="tab-pill active px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap" data-tab="prices">
          Prices
        </button>
        <button class="tab-pill px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap" data-tab="funding">
          Funding
        </button>
        <button class="tab-pill px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap" data-tab="leaderboard">
          Leaderboard
        </button>
        <button class="tab-pill px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap" data-tab="arb">
          Arb Estimator
        </button>
      </div>
    </div>
  </header>

  <main class="content-pad">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 space-y-6">

      <!-- Filters (kept same data + logic; purely UI) -->
      <section class="glass rounded-3xl p-5 sm:p-6">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div>
            <div class="font-orbitron text-sm tracking-[0.18em] text-gray-100">FILTERS</div>
            <div class="text-xs text-gray-400 mt-1" id="filterStatus">Choose exchanges + coins, then “Apply filters”.</div>
          </div>
          <div class="flex gap-2">
            <button class="btn-ghost px-4 py-2 rounded-xl text-sm" id="resetFilters">Reset defaults</button>
            <button class="btn-grad px-4 py-2 rounded-xl text-sm" id="applyFilters">Apply filters</button>
          </div>
        </div>

        <div class="mt-5 grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="glass rounded-2xl p-4 purple-ring">
            <div class="text-xs text-gray-300 font-semibold mb-3">Exchanges</div>
            <div class="grid grid-cols-2 gap-2" id="exchChecks"></div>
            <div class="mt-3 flex gap-2">
              <button class="btn-ghost px-3 py-2 rounded-xl text-xs" id="exAll">Select all</button>
              <button class="btn-ghost px-3 py-2 rounded-xl text-xs" id="exNone">Clear</button>
            </div>
          </div>

          <div class="glass rounded-2xl p-4 neon-ring">
            <div class="text-xs text-gray-300 font-semibold mb-3">Coins</div>
            <div class="max-h-56 overflow-auto pr-2 grid grid-cols-3 gap-2" id="coinChecks"></div>
            <div class="mt-3 flex gap-2">
              <button class="btn-ghost px-3 py-2 rounded-xl text-xs" id="cAll">Select all</button>
              <button class="btn-ghost px-3 py-2 rounded-xl text-xs" id="cNone">Clear</button>
            </div>
          </div>
        </div>

        <div class="mt-4 text-xs text-gray-400">
          <span class="text-gray-300 font-semibold">Row glow:</span>
          rows highlight when spread across selected exchanges ≥ <span class="font-monoNums" style="color:var(--neon)">5 bps</span>.
        </div>
      </section>

      <!-- PRICES TAB -->
      <section id="tab-prices" class="tab-panel space-y-4">
        <div class="glass rounded-3xl p-5 sm:p-6">
          <div class="flex flex-wrap items-center justify-between gap-3">
            <div>
              <div class="font-orbitron text-sm tracking-[0.18em] text-gray-100">PRICES</div>
              <div class="text-xs text-gray-400 mt-1">
                Spread bps = 10,000 × (max − min) / min · “24h High” stored in your browser
              </div>
            </div>
            <div class="text-xs text-gray-200 glass rounded-2xl px-3 py-2">
              <span class="text-gray-400">Updated:</span>
              <span id="priceStatus" class="font-monoNums">Loading…</span>
            </div>
          </div>

          <div class="mt-4 overflow-x-auto rounded-2xl">
            <table class="w-full zebra">
              <thead id="pricesHead" class="text-xs uppercase tracking-wider text-gray-300">
                <!-- injected -->
              </thead>
              <tbody id="priceRows" class="text-sm">
                <!-- injected -->
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- FUNDING TAB -->
      <section id="tab-funding" class="tab-panel hidden space-y-4">
        <div class="glass rounded-3xl p-5 sm:p-6">
          <div class="flex flex-wrap items-center justify-between gap-3">
            <div>
              <div class="font-orbitron text-sm tracking-[0.18em] text-gray-100">FUNDING</div>
              <div class="text-xs text-gray-400 mt-1">
                365-day = rate_per_window × (365×24 / interval_hours)
              </div>
            </div>
            <div class="text-xs text-gray-200 glass rounded-2xl px-3 py-2">
              <span class="text-gray-400">Updated:</span>
              <span id="fundingStatus" class="font-monoNums">Loading…</span>
            </div>
          </div>

          <div class="mt-4 overflow-x-auto rounded-2xl">
            <table class="w-full zebra">
              <thead id="fundingHead" class="text-xs uppercase tracking-wider text-gray-300">
                <!-- injected -->
              </thead>
              <tbody id="fundingRows" class="text-sm">
                <!-- injected -->
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- LEADERBOARD TAB -->
      <section id="tab-leaderboard" class="tab-panel hidden space-y-4">
        <div class="glass rounded-3xl p-5 sm:p-6">
          <div class="flex flex-wrap items-center justify-between gap-3">
            <div>
              <div class="font-orbitron text-sm tracking-[0.18em] text-gray-100">LEADERBOARD</div>
              <div class="text-xs text-gray-400 mt-1">
                Ranked by highest spread (bps) across your selected exchanges
              </div>
            </div>
            <div class="text-xs text-gray-200 glass rounded-2xl px-3 py-2">
              <span class="text-gray-400">Snapshot:</span>
              <span id="leaderStatus" class="font-monoNums">Waiting…</span>
            </div>
          </div>

          <div class="mt-4 overflow-x-auto rounded-2xl">
            <table class="w-full zebra">
              <thead class="text-xs uppercase tracking-wider text-gray-300">
                <tr>
                  <th class="py-3 px-3 text-left">Coin</th>
                  <th class="py-3 px-3 text-left">Buy @</th>
                  <th class="py-3 px-3 text-left">Sell @</th>
                  <th class="py-3 px-3 text-right">Spread (bps)</th>
                  <th class="py-3 px-3 text-right">24h High (bps)</th>
                </tr>
              </thead>
              <tbody id="leaderRows" class="text-sm">
                <tr><td colspan="5" class="py-4 px-3 text-xs text-gray-400">Waiting for first price refresh…</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- ARB TAB -->
      <section id="tab-arb" class="tab-panel hidden space-y-4">
        <div class="glass rounded-3xl p-5 sm:p-6">
          <div class="flex flex-wrap items-center justify-between gap-3">
            <div>
              <div class="font-orbitron text-sm tracking-[0.18em] text-gray-100">ARB ESTIMATOR</div>
              <div class="text-xs text-gray-400 mt-1">
                Uses live prices · Gross ≈ Notional × (Convergence bps / 10,000)
              </div>
            </div>
          </div>

          <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="glass rounded-2xl p-4 purple-ring">
              <div class="text-xs text-gray-300 font-semibold mb-3">Inputs</div>

              <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div>
                  <label class="text-xs text-gray-400">Asset</label>
                  <select id="arbAsset" class="mt-1 w-full rounded-xl px-3 py-2 input-glass text-sm"></select>
                </div>
                <div>
                  <label class="text-xs text-gray-400">Notional (USD)</label>
                  <input id="arbNotional" type="number" value="100000" min="0" step="1000"
                         class="mt-1 w-full rounded-xl px-3 py-2 input-glass text-sm font-monoNums">
                </div>

                <div>
                  <label class="text-xs text-gray-400">Buy exchange</label>
                  <select id="arbBuyEx" class="mt-1 w-full rounded-xl px-3 py-2 input-glass text-sm"></select>
                </div>
                <div>
                  <label class="text-xs text-gray-400">Sell exchange</label>
                  <select id="arbSellEx" class="mt-1 w-full rounded-xl px-3 py-2 input-glass text-sm"></select>
                </div>

                <div>
                  <label class="text-xs text-gray-400">Target convergence (bps)</label>
                  <input id="arbConvBps" type="number" value="5" step="0.1"
                         class="mt-1 w-full rounded-xl px-3 py-2 input-glass text-sm font-monoNums">
                </div>
                <div>
                  <label class="text-xs text-gray-400">Total costs (bps)</label>
                  <input id="arbCostsBps" type="number" value="3" step="0.1"
                         class="mt-1 w-full rounded-xl px-3 py-2 input-glass text-sm font-monoNums">
                </div>
              </div>

              <div class="mt-4 flex gap-2">
                <button class="btn-grad px-4 py-2 rounded-xl text-sm" id="arbRecalc">Recalculate</button>
              </div>
            </div>

            <div class="glass rounded-2xl p-4 neon-ring">
              <div class="text-xs text-gray-300 font-semibold mb-3">Output</div>

              <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div class="glass rounded-2xl p-3">
                  <div class="text-xs text-gray-400">Current buy/sell spread</div>
                  <div id="arbCurBps" class="mt-1 font-monoNums text-lg">—</div>
                </div>
                <div class="glass rounded-2xl p-3">
                  <div class="text-xs text-gray-400">Gross PnL (USD)</div>
                  <div id="arbGross" class="mt-1 font-monoNums text-lg">—</div>
                </div>
                <div class="glass rounded-2xl p-3">
                  <div class="text-xs text-gray-400">Costs (USD)</div>
                  <div id="arbCosts" class="mt-1 font-monoNums text-lg">—</div>
                </div>
                <div class="glass rounded-2xl p-3">
                  <div class="text-xs text-gray-400">Net PnL (USD)</div>
                  <div id="arbNet" class="mt-1 font-monoNums text-lg">—</div>
                </div>
              </div>

              <div class="mt-4 text-xs text-gray-400">
                Tip: pick the cheapest exchange as Buy and most expensive as Sell for a pure spread convergence arb.
              </div>
            </div>
          </div>
        </div>
      </section>

      <footer class="pb-10 text-xs text-gray-500">
        <div class="text-center">
          Built with vanilla JS · Tailwind · Glassmorphism · Neon accents
        </div>
      </footer>

    </div>
  </main>

<script>
  // ======================================================================
  // IMPORTANT: DATA LOGIC UNCHANGED (same fetch + calculations as before).
  // Only structure/styling has been upgraded.
  // ======================================================================

  // === your worker ===
  const PROXY_BASE = "https://purple-sky-264e.jasper-cooney.workers.dev/?url=";

  const BPS_HIGHLIGHT = 5;
  const PRICES_REFRESH_MS = 3000;
  const FUNDING_REFRESH_MS = 60000;

  // 24h high spread across SELECTED exchanges (minute buckets)
  const HIGH_WINDOW_MINUTES = 24 * 60;
  const HIGH_STORE_KEY = "perpinsights_24h_high_spread_bps_v2";

  // Same coins you currently had
  const COINS = ["BTC","ETH","SOL","XRP","ZEC","DOGE","ADA","LINK","AVAX","LTC","BCH","DOT"];

  // Exchange list
  const EXCHANGES = [
    { key:"hyper",  name:"Hyperliquid" },
    { key:"aster",  name:"Aster" },
    { key:"kraken", name:"Kraken" },
    { key:"okx",    name:"OKX" },
  ];

  // Symbol mappings per exchange
  const MAP = {
    hyper:  { BTC:"BTC", ETH:"ETH", SOL:"SOL", XRP:"XRP", ZEC:"ZEC", DOGE:"DOGE", ADA:"ADA", LINK:"LINK", AVAX:"AVAX", LTC:"LTC", BCH:"BCH", DOT:"DOT" },
    aster:  { BTC:"BTCUSDT", ETH:"ETHUSDT", SOL:"SOLUSDT", XRP:"XRPUSDT", ZEC:"ZECUSDT", DOGE:"DOGEUSDT", ADA:"ADAUSDT", LINK:"LINKUSDT", AVAX:"AVAXUSDT", LTC:"LTCUSDT", BCH:"BCHUSDT", DOT:"DOTUSDT" },
    okx:    { BTC:"BTC-USDT-SWAP", ETH:"ETH-USDT-SWAP", SOL:"SOL-USDT-SWAP", XRP:"XRP-USDT-SWAP", ZEC:"ZEC-USDT-SWAP", DOGE:"DOGE-USDT-SWAP", ADA:"ADA-USDT-SWAP", LINK:"LINK-USDT-SWAP", AVAX:"AVAX-USDT-SWAP", LTC:"LTC-USDT-SWAP", BCH:"BCH-USDT-SWAP", DOT:"DOT-USDT-SWAP" },
    // Kraken Futures perpetuals commonly use XBT not BTC
    kraken: { BTC:"PF_XBTUSD", ETH:"PF_ETHUSD", SOL:"PF_SOLUSD", XRP:"PF_XRPUSD", ZEC:"PF_ZECUSD", DOGE:"PF_DOGEUSD", ADA:"PF_ADAUSD", LINK:"PF_LINKUSD", AVAX:"PF_AVAXUSD", LTC:"PF_LTCUSD", BCH:"PF_BCHUSD", DOT:"PF_DOTUSD" },
  };

  // ===== DOM =====
  const liveStatusText = document.getElementById("liveStatusText");

  const exchChecks = document.getElementById("exchChecks");
  const coinChecks = document.getElementById("coinChecks");
  const filterStatus = document.getElementById("filterStatus");

  const pricesHead = document.getElementById("pricesHead");
  const priceRows = document.getElementById("priceRows");
  const priceStatus = document.getElementById("priceStatus");

  const fundingHead = document.getElementById("fundingHead");
  const fundingRows = document.getElementById("fundingRows");
  const fundingStatus = document.getElementById("fundingStatus");

  const leaderStatus = document.getElementById("leaderStatus");
  const leaderRows = document.getElementById("leaderRows");

  const arbAsset = document.getElementById("arbAsset");
  const arbBuyEx = document.getElementById("arbBuyEx");
  const arbSellEx = document.getElementById("arbSellEx");
  const arbNotional = document.getElementById("arbNotional");
  const arbConvBps = document.getElementById("arbConvBps");
  const arbCostsBps = document.getElementById("arbCostsBps");
  const arbRecalc = document.getElementById("arbRecalc");
  const arbCurBps = document.getElementById("arbCurBps");
  const arbGross = document.getElementById("arbGross");
  const arbCosts = document.getElementById("arbCosts");
  const arbNet = document.getElementById("arbNet");

  // ===== Tabs =====
  function initTabs() {
    const btns = document.querySelectorAll(".tab-pill");
    const panels = {
      prices: document.getElementById("tab-prices"),
      funding: document.getElementById("tab-funding"),
      leaderboard: document.getElementById("tab-leaderboard"),
      arb: document.getElementById("tab-arb"),
    };

    btns.forEach(b => {
      b.addEventListener("click", () => {
        btns.forEach(x => x.classList.remove("active"));
        b.classList.add("active");

        for (const p of Object.values(panels)) p.classList.add("hidden");
        panels[b.dataset.tab].classList.remove("hidden");

        if (b.dataset.tab === "arb") renderArb();
        if (b.dataset.tab === "leaderboard") renderLeaderboard();
      });
    });
  }

  // ===== Filters state =====
  const FILTER_KEY = "perpinsights_filters_v1";
  let selectedEx = new Set(EXCHANGES.map(x => x.key));
  let selectedCoins = new Set(COINS);

  function saveFilters() {
    try {
      localStorage.setItem(FILTER_KEY, JSON.stringify({
        ex: [...selectedEx],
        coins: [...selectedCoins],
      }));
    } catch {}
  }
  function loadFilters() {
    try {
      const raw = localStorage.getItem(FILTER_KEY);
      if (!raw) return;
      const j = JSON.parse(raw);
      if (Array.isArray(j.ex)) selectedEx = new Set(j.ex);
      if (Array.isArray(j.coins)) selectedCoins = new Set(j.coins);
    } catch {}
  }

  function renderFilterUI() {
    exchChecks.innerHTML = EXCHANGES.map(e => `
      <label class="flex items-center gap-2 text-sm text-gray-200">
        <input type="checkbox" class="accent-[var(--neon)]" data-ex="${e.key}" ${selectedEx.has(e.key) ? "checked" : ""}/>
        <span>${e.name}</span>
      </label>
    `).join("");

    coinChecks.innerHTML = COINS.map(c => `
      <label class="flex items-center gap-2 text-sm text-gray-200">
        <input type="checkbox" class="accent-[var(--purple)]" data-coin="${c}" ${selectedCoins.has(c) ? "checked" : ""}/>
        <span class="font-monoNums">${c}</span>
      </label>
    `).join("");

    exchChecks.querySelectorAll("input[type=checkbox]").forEach(cb => {
      cb.addEventListener("change", () => {
        const k = cb.dataset.ex;
        cb.checked ? selectedEx.add(k) : selectedEx.delete(k);
      });
    });

    coinChecks.querySelectorAll("input[type=checkbox]").forEach(cb => {
      cb.addEventListener("change", () => {
        const k = cb.dataset.coin;
        cb.checked ? selectedCoins.add(k) : selectedCoins.delete(k);
      });
    });
  }

  function setAllEx(on) {
    selectedEx = new Set(on ? EXCHANGES.map(x=>x.key) : []);
    renderFilterUI();
  }
  function setAllCoins(on) {
    selectedCoins = new Set(on ? COINS : []);
    renderFilterUI();
  }

  document.getElementById("exAll").onclick = () => setAllEx(true);
  document.getElementById("exNone").onclick = () => setAllEx(false);
  document.getElementById("cAll").onclick = () => setAllCoins(true);
  document.getElementById("cNone").onclick = () => setAllCoins(false);

  document.getElementById("applyFilters").onclick = () => {
    if (selectedEx.size < 1) { alert("Select at least 1 exchange"); return; }
    if (selectedCoins.size < 1) { alert("Select at least 1 coin"); return; }

    saveFilters();
    filterStatus.textContent = `Applied: ${selectedEx.size} exchanges, ${selectedCoins.size} coins.`;
    buildTables();
    refreshAllDropdowns();
    refreshPrices();
    refreshFunding();
  };

  document.getElementById("resetFilters").onclick = () => {
    selectedEx = new Set(EXCHANGES.map(x=>x.key));
    selectedCoins = new Set(COINS);
    saveFilters();
    renderFilterUI();
    document.getElementById("applyFilters").click();
  };

  // ===== Helpers =====
  function nowMinuteEpoch() { return Math.floor(Date.now() / 60000); }

  function exName(exKey) {
    return (EXCHANGES.find(e => e.key === exKey)?.name) || exKey;
  }

  function fmtUsd(x) {
    if (x === undefined || x === null || x === "" || Number.isNaN(Number(x))) return "—";
    const n = Number(x);
    return n >= 1
      ? "$" + n.toLocaleString(undefined, { maximumFractionDigits: 2 })
      : "$" + n.toLocaleString(undefined, { maximumFractionDigits: 6 });
  }
  function fmtBpsAbs(x) {
    if (!Number.isFinite(x)) return "—";
    const abs = Math.abs(x);
    return abs.toFixed(abs < 10 ? 2 : 1) + " bps";
  }
  function fmtBpsSigned(x) {
    if (!Number.isFinite(x)) return { text:"—", cls:"" };
    const abs = Math.abs(x);
    return { text: (x>=0?"+":"−") + abs.toFixed(abs < 10 ? 2 : 1) + " bps", cls: x>0?"text-emerald-300":(x<0?"text-rose-300":"") };
  }
  function fmtFunding(rate) {
    if (!Number.isFinite(rate)) return "—";
    const p = rate * 100;
    return (p>=0?"":"−") + Math.abs(p).toFixed(Math.abs(p) < 0.01 ? 4 : 3) + "%";
  }
  function fmtIntervalH(h) {
    if (!Number.isFinite(h) || h<=0) return "—";
    return h.toFixed(h < 10 ? 2 : 1) + "h";
  }
  function aprFromRate(ratePerWindow, intervalH) {
    if (!Number.isFinite(ratePerWindow) || !Number.isFinite(intervalH) || intervalH<=0) return "—";
    const windowsPerYear = (365*24)/intervalH;
    const apr = ratePerWindow * windowsPerYear * 100;
    return (apr>=0?"":"−") + Math.abs(apr).toFixed(Math.abs(apr) < 1 ? 3 : 2) + "%";
  }
  function money(x) {
    if (!Number.isFinite(x)) return "—";
    return (x>=0?"":"−") + "$" + Math.abs(x).toLocaleString(undefined, { maximumFractionDigits: 2 });
  }

  async function fetchJson(url, options) {
    const r = await fetch(PROXY_BASE + encodeURIComponent(url), { cache:"no-store", ...(options||{}) });
    if (!r.ok) throw new Error(String(r.status));
    return r.json();
  }

  // ===== Local storage: 24h High spread (per coin, minute bucket) =====
  let highStore = {}; // { [coin]: [{m, s}] } s=spreadAbsBps

  function loadHighStore() {
    try { highStore = JSON.parse(localStorage.getItem(HIGH_STORE_KEY) || "{}"); } catch { highStore = {}; }
  }
  function saveHighStore() {
    try { localStorage.setItem(HIGH_STORE_KEY, JSON.stringify(highStore)); } catch {}
  }
  function pruneHighStore() {
    const cutoff = nowMinuteEpoch() - HIGH_WINDOW_MINUTES;
    for (const c of Object.keys(highStore)) {
      const arr = Array.isArray(highStore[c]) ? highStore[c] : [];
      highStore[c] = arr.filter(x => x && Number.isFinite(x.m) && x.m >= cutoff && Number.isFinite(x.s));
      if (highStore[c].length === 0) delete highStore[c];
    }
  }
  function updateHigh(coin, spreadAbsBps) {
    if (!Number.isFinite(spreadAbsBps)) return;
    const m = nowMinuteEpoch();
    if (!Array.isArray(highStore[coin])) highStore[coin] = [];
    const arr = highStore[coin];
    const last = arr.length ? arr[arr.length - 1] : null;
    if (last && last.m === m) {
      if (spreadAbsBps > last.s) last.s = spreadAbsBps;
    } else {
      arr.push({ m, s: spreadAbsBps });
    }
    const cutoff = m - HIGH_WINDOW_MINUTES;
    while (arr.length && arr[0].m < cutoff) arr.shift();
  }
  function get24hHigh(coin) {
    const arr = highStore[coin];
    if (!Array.isArray(arr) || !arr.length) return null;
    let best = arr[0];
    for (const x of arr) if (x && Number.isFinite(x.s) && x.s > best.s) best = x;
    return best;
  }

  // ===== Data caches =====
  // prices[exchange][coin] = priceNumber
  const prices = {};
  // funding[exchange][coin] = { rate, intervalH }
  const funding = {};

  // ===== Leaderboard cache (pure derived display) =====
  let lastSpreadSnapshot = []; // [{coin, spreadBps, buyEx, sellEx}]

  // ===== Fetchers (same as before) =====
  async function loadHyperliquid() {
    const j = await fetchJson("https://api.hyperliquid.xyz/info", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ type:"metaAndAssetCtxs" })
    });
    const meta = j[0], ctxs = j[1];
    const map = new Map();
    meta.universe.forEach((u,i) => map.set(u.name, ctxs[i] || {}));

    for (const coin of COINS) {
      const sym = MAP.hyper[coin];
      if (!sym) continue;
      const c = map.get(sym);
      const px = Number(c?.markPx);
      const fr = Number(c?.funding);
      if (!prices.hyper) prices.hyper = {};
      if (!funding.hyper) funding.hyper = {};
      if (Number.isFinite(px)) prices.hyper[coin] = px;
      if (Number.isFinite(fr)) funding.hyper[coin] = { rate: fr, intervalH: 1 }; // hourly
    }
  }

  async function loadAster() {
    const [p, prem] = await Promise.all([
      fetchJson("https://fapi.asterdex.com/fapi/v1/ticker/price"),
      fetchJson("https://fapi.asterdex.com/fapi/v1/premiumIndex")
    ]);

    const pMap = new Map();
    if (Array.isArray(p)) for (const x of p) pMap.set(x.symbol, x.price);

    const fMap = new Map();
    if (Array.isArray(prem)) for (const x of prem) fMap.set(x.symbol, x);

    for (const coin of COINS) {
      const sym = MAP.aster[coin];
      if (!sym) continue;

      const px = Number(pMap.get(sym));
      if (!prices.aster) prices.aster = {};
      if (Number.isFinite(px)) prices.aster[coin] = px;

      const obj = fMap.get(sym);
      const r = Number(obj?.lastFundingRate ?? obj?.fundingRate ?? obj?.funding);
      let intervalH = null;
      const last = Number(obj?.lastFundingTime);
      const next = Number(obj?.nextFundingTime);
      if (Number.isFinite(last) && Number.isFinite(next) && next > last) intervalH = (next-last)/3600000;
      if (!Number.isFinite(intervalH) || intervalH<=0) intervalH = 8;

      if (!funding.aster) funding.aster = {};
      if (Number.isFinite(r)) funding.aster[coin] = { rate: r, intervalH };
    }
  }

  async function loadOKX() {
    const tickTasks = [];
    const fundTasks = [];

    for (const coin of COINS) {
      const instId = MAP.okx[coin];
      if (!instId) continue;

      tickTasks.push((async () => {
        const j = await fetchJson(`https://www.okx.com/api/v5/market/ticker?instId=${encodeURIComponent(instId)}`);
        const d = j?.data?.[0];
        const px = Number(d?.last ?? d?.markPx ?? d?.idxPx);
        if (!prices.okx) prices.okx = {};
        if (Number.isFinite(px)) prices.okx[coin] = px;
      })());

      fundTasks.push((async () => {
        const j = await fetchJson(`https://www.okx.com/api/v5/public/funding-rate?instId=${encodeURIComponent(instId)}`);
        const d = j?.data?.[0];
        const r = Number(d?.fundingRate);
        const ft = Number(d?.fundingTime);
        const nft = Number(d?.nextFundingTime);
        let intervalH = null;
        if (Number.isFinite(ft) && Number.isFinite(nft) && nft > ft) intervalH = (nft-ft)/3600000;
        if (!Number.isFinite(intervalH) || intervalH<=0) intervalH = 8;
        if (!funding.okx) funding.okx = {};
        if (Number.isFinite(r)) funding.okx[coin] = { rate: r, intervalH };
      })());
    }

    await Promise.allSettled([...tickTasks, ...fundTasks]);
  }

  async function loadKrakenFutures() {
    const j = await fetchJson("https://futures.kraken.com/derivatives/api/v3/tickers");
    const arr = j?.tickers || j?.result || j;
    const tMap = new Map();
    if (Array.isArray(arr)) {
      for (const t of arr) {
        const sym = t?.symbol || t?.instrument || t?.product_id;
        if (sym) tMap.set(sym, t);
      }
    }

    if (!prices.kraken) prices.kraken = {};
    if (!funding.kraken) funding.kraken = {};

    for (const coin of COINS) {
      const sym = MAP.kraken[coin];
      const t = tMap.get(sym);
      if (!t) continue;

      const px = Number(t?.markPrice ?? t?.mark_price ?? t?.last ?? t?.lastPrice ?? t?.last_price);
      if (Number.isFinite(px)) prices.kraken[coin] = px;

      const fr = Number(t?.fundingRate ?? t?.funding_rate ?? t?.funding_rate_prediction ?? t?.fundingRatePrediction);
      if (Number.isFinite(fr)) funding.kraken[coin] = { rate: fr, intervalH: 1 };
    }
  }

  // ===== Build table headers based on selected exchanges =====
  function buildTables() {
    const exList = EXCHANGES.filter(e => selectedEx.has(e.key));
    const coinsList = COINS.filter(c => selectedCoins.has(c));

    pricesHead.innerHTML = `
      <tr>
        <th class="py-3 px-3 text-left">Asset</th>
        ${exList.map(e => `<th class="py-3 px-3 text-right">${e.name}</th>`).join("")}
        <th class="py-3 px-3 text-right">Spread (bps)</th>
        <th class="py-3 px-3 text-right">24h High (bps)</th>
      </tr>
    `;

    fundingHead.innerHTML = `
      <tr>
        <th class="py-3 px-3 text-left">Asset</th>
        ${exList.map(e => `
          <th class="py-3 px-3 text-right">${e.name} Funding</th>
          <th class="py-3 px-3 text-right">${e.name} Interval</th>
          <th class="py-3 px-3 text-right">${e.name} 365-day</th>
        `).join("")}
      </tr>
    `;

    // bodies injected on refresh; placeholders keep layout stable
    priceRows.innerHTML = coinsList.map(c => `<tr><td class="py-3 px-3 font-monoNums">${c}</td></tr>`).join("");
    fundingRows.innerHTML = coinsList.map(c => `<tr><td class="py-3 px-3 font-monoNums">${c}</td></tr>`).join("");
  }

  // ===== Render Prices =====
  function renderPrices() {
    pruneHighStore();

    const exList = EXCHANGES.filter(e => selectedEx.has(e.key));
    const coinsList = COINS.filter(c => selectedCoins.has(c));

    const spreadSnap = [];

    priceRows.innerHTML = coinsList.map(coin => {
      const pxs = []; // [{ex, p}]
      const cells = exList.map(e => {
        const p = prices?.[e.key]?.[coin];
        if (Number.isFinite(p)) pxs.push({ ex: e.key, p });
        return `<td class="py-3 px-3 text-right font-monoNums">${fmtUsd(p)}</td>`;
      }).join("");

      let spreadBps = null;
      let buyEx = null;
      let sellEx = null;

      if (pxs.length >= 2) {
        pxs.sort((a,b) => a.p - b.p);
        const min = pxs[0];
        const max = pxs[pxs.length - 1];
        if (min.p > 0) {
          spreadBps = 10000 * (max.p - min.p) / min.p;
          buyEx = min.ex;
          sellEx = max.ex;
        }
      }

      if (Number.isFinite(spreadBps)) {
        updateHigh(coin, spreadBps);
        spreadSnap.push({ coin, spreadBps, buyEx, sellEx });
      }

      const hi = get24hHigh(coin);
      const hot = Number.isFinite(spreadBps) && spreadBps >= BPS_HIGHLIGHT;
      const spreadTxt = Number.isFinite(spreadBps) ? fmtBpsAbs(spreadBps) : "—";
      const highTxt = hi ? fmtBpsAbs(hi.s) : "—";
      const title = hi ? `title="Observed at: ${new Date(hi.m*60000).toLocaleString()}"` : "";

      return `
        <tr class="${hot ? "hot-row" : ""}">
          <td class="py-3 px-3 font-monoNums">${coin}</td>
          ${cells}
          <td class="py-3 px-3 text-right font-monoNums">${spreadTxt}</td>
          <td class="py-3 px-3 text-right font-monoNums" ${title}>${highTxt}</td>
        </tr>
      `;
    }).join("");

    saveHighStore();

    // update leaderboard cache
    lastSpreadSnapshot = spreadSnap
      .slice()
      .sort((a,b) => (b.spreadBps ?? -Infinity) - (a.spreadBps ?? -Infinity));
    renderLeaderboard();
  }

  // ===== Render Funding =====
  function renderFunding() {
    const exList = EXCHANGES.filter(e => selectedEx.has(e.key));
    const coinsList = COINS.filter(c => selectedCoins.has(c));

    fundingRows.innerHTML = coinsList.map(coin => {
      const cells = exList.map(e => {
        const rec = funding?.[e.key]?.[coin];
        const r = Number(rec?.rate);
        const ih = Number(rec?.intervalH);
        return `
          <td class="py-3 px-3 text-right font-monoNums">${fmtFunding(r)}</td>
          <td class="py-3 px-3 text-right font-monoNums">${fmtIntervalH(ih)}</td>
          <td class="py-3 px-3 text-right font-monoNums">${aprFromRate(r, ih)}</td>
        `;
      }).join("");

      return `<tr><td class="py-3 px-3 font-monoNums">${coin}</td>${cells}</tr>`;
    }).join("");
  }

  // ===== Leaderboard =====
  function renderLeaderboard() {
    const now = new Date().toLocaleTimeString();
    leaderStatus.textContent = lastSpreadSnapshot.length ? now : "Waiting…";

    if (!lastSpreadSnapshot.length) {
      leaderRows.innerHTML = `<tr><td colspan="5" class="py-4 px-3 text-xs text-gray-400">Waiting for first price refresh…</td></tr>`;
      return;
    }

    const top = lastSpreadSnapshot.slice(0, 20);

    leaderRows.innerHTML = top.map(row => {
      const hi = get24hHigh(row.coin);
      const hot = Number.isFinite(row.spreadBps) && row.spreadBps >= BPS_HIGHLIGHT;
      return `
        <tr class="${hot ? "hot-row" : ""}">
          <td class="py-3 px-3 font-monoNums">${row.coin}</td>
          <td class="py-3 px-3">${row.buyEx ? `<span class="text-emerald-200">${exName(row.buyEx)}</span>` : "—"}</td>
          <td class="py-3 px-3">${row.sellEx ? `<span class="text-purple-200">${exName(row.sellEx)}</span>` : "—"}</td>
          <td class="py-3 px-3 text-right font-monoNums">${Number.isFinite(row.spreadBps) ? fmtBpsAbs(row.spreadBps) : "—"}</td>
          <td class="py-3 px-3 text-right font-monoNums">${hi ? fmtBpsAbs(hi.s) : "—"}</td>
        </tr>
      `;
    }).join("");
  }

  // ===== Dropdowns / arb calculator =====
  function refreshAllDropdowns() {
    const coinsList = COINS.filter(c => selectedCoins.has(c));
    const exList = EXCHANGES.filter(e => selectedEx.has(e.key));

    arbAsset.innerHTML = coinsList.map(c => `<option value="${c}">${c}</option>`).join("");
    arbBuyEx.innerHTML = exList.map(e => `<option value="${e.key}">${e.name}</option>`).join("");
    arbSellEx.innerHTML = exList.map(e => `<option value="${e.key}">${e.name}</option>`).join("");

    if (coinsList.length) {
      if (!coinsList.includes(arbAsset.value)) arbAsset.value = coinsList[0];
    }
    if (exList.length >= 2) {
      arbBuyEx.value = exList[0].key;
      arbSellEx.value = exList[1].key;
    }
  }

  function renderArb() {
    const coin = arbAsset.value;
    const buy = arbBuyEx.value;
    const sell = arbSellEx.value;

    const buyPx = Number(prices?.[buy]?.[coin]);
    const sellPx = Number(prices?.[sell]?.[coin]);

    let curBps = null;
    if (Number.isFinite(buyPx) && Number.isFinite(sellPx) && buyPx > 0) {
      curBps = 10000 * (sellPx - buyPx) / buyPx;
    }
    const bpsCell = Number.isFinite(curBps) ? fmtBpsSigned(curBps) : { text: "—", cls: "" };
    arbCurBps.textContent = bpsCell.text;
    arbCurBps.className = "mt-1 font-monoNums text-lg " + (bpsCell.cls || "");

    const notional = Number(arbNotional.value || 0);
    const conv = Number(arbConvBps.value || 0);
    const costsBps = Number(arbCostsBps.value || 0);

    const gross = notional * (conv / 10000);
    const costs = notional * (costsBps / 10000);
    const net = gross - costs;

    arbGross.textContent = money(gross);
    arbCosts.textContent = money(costs);
    arbNet.textContent = money(net);
    arbNet.className = "mt-1 font-monoNums text-lg " + (net >= 0 ? "text-emerald-300" : "text-rose-300");
  }

  // ===== Refresh loops =====
  async function refreshPrices() {
    const start = Date.now();
    priceStatus.textContent = "Updating…";

    // Clear only selected exchanges so removed ones don't show stale
    for (const ex of Object.keys(prices)) prices[ex] = {};

    const tasks = [];
    if (selectedEx.has("hyper")) tasks.push(loadHyperliquid());
    if (selectedEx.has("aster")) tasks.push(loadAster());
    if (selectedEx.has("okx")) tasks.push(loadOKX());
    if (selectedEx.has("kraken")) tasks.push(loadKrakenFutures());

    const results = await Promise.allSettled(tasks);
    const ok = results.some(r => r.status === "fulfilled");

    renderPrices();
    renderArb();

    const ms = Date.now() - start;
    priceStatus.textContent = `${new Date().toLocaleTimeString()} · ${ms}ms`;

    // live status indicator text
    liveStatusText.textContent = ok ? "LIVE" : "DEGRADED";
    liveStatusText.style.color = ok ? "var(--neon)" : "#fca5a5";
  }

  async function refreshFunding() {
    const start = Date.now();
    fundingStatus.textContent = "Updating…";

    for (const ex of Object.keys(funding)) funding[ex] = {};

    // Loaders fill both prices/funding; we keep the same approach as your existing code
    const tasks = [];
    if (selectedEx.has("hyper")) tasks.push(loadHyperliquid());
    if (selectedEx.has("aster")) tasks.push(loadAster());
    if (selectedEx.has("okx")) tasks.push(loadOKX());
    if (selectedEx.has("kraken")) tasks.push(loadKrakenFutures());

    const results = await Promise.allSettled(tasks);
    const ok = results.some(r => r.status === "fulfilled");

    renderFunding();

    const ms = Date.now() - start;
    fundingStatus.textContent = `${new Date().toLocaleTimeString()} · ${ms}ms`;

    // live status indicator text
    liveStatusText.textContent = ok ? "LIVE" : "DEGRADED";
    liveStatusText.style.color = ok ? "var(--neon)" : "#fca5a5";
  }

  // ===== Init =====
  function init() {
    initTabs();

    loadFilters();
    loadHighStore();
    pruneHighStore();
    saveHighStore();

    renderFilterUI();
    buildTables();
    refreshAllDropdowns();

    // events
    arbRecalc.onclick = renderArb;
    ["change","input"].forEach(ev => {
      arbAsset.addEventListener(ev, renderArb);
      arbBuyEx.addEventListener(ev, renderArb);
      arbSellEx.addEventListener(ev, renderArb);
      arbNotional.addEventListener(ev, renderArb);
      arbConvBps.addEventListener(ev, renderArb);
      arbCostsBps.addEventListener(ev, renderArb);
    });

    // first fetch
    refreshPrices();
    refreshFunding();
    renderLeaderboard();

    setInterval(refreshPrices, PRICES_REFRESH_MS);
    setInterval(refreshFunding, FUNDING_REFRESH_MS);

    // initial status
    liveStatusText.textContent = "LIVE";
    liveStatusText.style.color = "var(--neon)";
  }

  init();
</script>
</body>
</html>
